import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
//const proj4 = require('proj4');
//const Proj = proj4.Proj;
//const defs = proj4.defs;
//proj4.InterfaceProjection;
//const InterfaceCoordinates = proj4.InterfaceCoordinates;
//const TemplateCoordinates = proj4.TemplateCoordinates;
//const proj4 = require('proj4').default;
import * as proj4 from 'proj4';
var D2R = Math.PI / 180;
var WMSService = /** @class */ (function () {
    function WMSService() {
        this.webMercator = (proj4.default || proj4).Proj('EPSG:3857');
        //this.webMercator = proj4.Proj(proj4.defs('EPSG:3857'));
    }
    WMSService_1 = WMSService;
    WMSService.prototype.pointToWebMercator = function (pt) {
        var ptRadians = { x: pt.lng() * D2R, y: pt.lat() * D2R };
        var ptWM = this.webMercator.forward({ x: ptRadians.x, y: ptRadians.y });
        return ptWM;
    };
    ;
    WMSService.prototype.computeTileBounds = function (map, coord, zoom) {
        var proj = map.getProjection();
        var zfactor = Math.pow(2, zoom);
        var xScale = WMSService_1.TILE_WIDTH / zfactor;
        var yScale = WMSService_1.TILE_HEIGHT / zfactor;
        var topLeftLatLng = proj.fromPointToLatLng({ x: coord.x * xScale, y: coord.y * yScale });
        var bottomRightLatLng = proj.fromPointToLatLng({ x: (coord.x + 1) * xScale, y: (coord.y + 1) * yScale });
        var topLeftWebMercator = this.pointToWebMercator(topLeftLatLng);
        var bottomRightWebMercator = this.pointToWebMercator(bottomRightLatLng);
        if (topLeftWebMercator.x > bottomRightWebMercator.x) {
            if (topLeftLatLng.lng() === 180.0) {
                topLeftWebMercator.x = -topLeftWebMercator.x;
            }
            else {
                bottomRightWebMercator.x = -bottomRightWebMercator.x;
            }
        }
        var bbox = [topLeftWebMercator.x, bottomRightWebMercator.y, bottomRightWebMercator.x, topLeftWebMercator.y];
        var bboxTxt = bbox.map(function (n) { return n.toFixed(20).replace(/\.?0+$/, ""); }); // Avoid e notation on small numbers
        return bboxTxt.join(',');
    };
    ;
    WMSService.prototype.buildImageMap = function (getMap, getURL, getOptions, getOpacity) {
        var me = this;
        return new window.google.maps.ImageMapType({
            getTileUrl: function (coord, zoom) {
                var theMap = getMap();
                if (!theMap) {
                    return '';
                }
                var bbox = me.computeTileBounds(theMap, coord, zoom);
                var url = getURL(zoom) + '&service=WMS&version=1.1.1&request=GetMap';
                url += "&BBOX=" + bbox; // set bounding box
                url += "&FORMAT=image/png"; //WMS format
                var layerParams = getOptions ? getOptions(zoom) : {};
                layerParams.width = WMSService_1.TILE_WIDTH;
                layerParams.height = WMSService_1.TILE_HEIGHT;
                for (var key in layerParams) {
                    url += '&' + key + '=' + layerParams[key];
                }
                url += "&SRS=EPSG:3857"; //set Web Mercator
                return url;
            },
            tileSize: new window.google.maps.Size(WMSService_1.TILE_SIZE, WMSService_1.TILE_SIZE),
            isPng: true,
            opacity: getOpacity ? getOpacity() : 1.0
        });
    };
    ;
    var WMSService_1;
    WMSService.TILE_SIZE = 256;
    WMSService.TILE_WIDTH = WMSService_1.TILE_SIZE;
    WMSService.TILE_HEIGHT = WMSService_1.TILE_SIZE;
    WMSService = WMSService_1 = tslib_1.__decorate([
        Injectable()
    ], WMSService);
    return WMSService;
}());
export { WMSService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid21zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9tYXAtd2FsZC8iLCJzb3VyY2VzIjpbIndtcy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLGlDQUFpQztBQUNqQywwQkFBMEI7QUFDMUIsMEJBQTBCO0FBQzFCLDRCQUE0QjtBQUM1QiwwREFBMEQ7QUFDMUQsd0RBQXdEO0FBRXhELHlDQUF5QztBQUN6QyxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMvQixJQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsRUFBRSxHQUFDLEdBQUcsQ0FBQztBQUd4QjtJQU1FO1FBQ0UsSUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFPLEtBQU0sQ0FBQyxPQUFPLElBQUksS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3JFLHlEQUF5RDtJQUMzRCxDQUFDO21CQVRVLFVBQVU7SUFhZCx1Q0FBa0IsR0FBekIsVUFBMEIsRUFBTTtRQUM5QixJQUFJLFNBQVMsR0FBRyxFQUFDLENBQUMsRUFBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUMsR0FBRyxFQUFDLENBQUMsRUFBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUMsR0FBRyxFQUFDLENBQUM7UUFDaEQsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsRUFBQyxDQUFDLEVBQUMsU0FBUyxDQUFDLENBQUMsRUFBQyxDQUFDLEVBQUMsU0FBUyxDQUFDLENBQUMsRUFBQyxDQUFDLENBQUM7UUFDbkUsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBQUEsQ0FBQztJQUVLLHNDQUFpQixHQUF4QixVQUF5QixHQUFPLEVBQUMsS0FBUyxFQUFDLElBQVc7UUFDcEQsSUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQy9CLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2hDLElBQUksTUFBTSxHQUFHLFlBQVUsQ0FBQyxVQUFVLEdBQUMsT0FBTyxDQUFDO1FBQzNDLElBQUksTUFBTSxHQUFHLFlBQVUsQ0FBQyxXQUFXLEdBQUMsT0FBTyxDQUFDO1FBRTVDLElBQUksYUFBYSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxFQUFDLENBQUMsRUFBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLE1BQU0sRUFBRSxDQUFDLEVBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxNQUFNLEVBQUMsQ0FBQyxDQUFDO1FBQ3JGLElBQUksaUJBQWlCLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEVBQUMsQ0FBQyxFQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLEVBQUUsQ0FBQyxFQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLEVBQUMsQ0FBQyxDQUFDO1FBRXJHLElBQUksa0JBQWtCLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2hFLElBQUksc0JBQXNCLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFFeEUsSUFBRyxrQkFBa0IsQ0FBQyxDQUFDLEdBQUcsc0JBQXNCLENBQUMsQ0FBQyxFQUFDO1lBQ2pELElBQUcsYUFBYSxDQUFDLEdBQUcsRUFBRSxLQUFHLEtBQUssRUFBQztnQkFDN0Isa0JBQWtCLENBQUMsQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO2FBQzlDO2lCQUFNO2dCQUNMLHNCQUFzQixDQUFDLENBQUMsR0FBRyxDQUFDLHNCQUFzQixDQUFDLENBQUMsQ0FBQzthQUN0RDtTQUNGO1FBQ0QsSUFBSSxJQUFJLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLEVBQUMsc0JBQXNCLENBQUMsQ0FBQyxFQUFDLHNCQUFzQixDQUFDLENBQUMsRUFBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6RyxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQUMsQ0FBQyxJQUFHLE9BQUEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFDLEVBQUUsQ0FBQyxFQUFsQyxDQUFrQyxDQUFDLENBQUMsQ0FBQyxvQ0FBb0M7UUFDckcsT0FBTyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFBQSxDQUFDO0lBRUssa0NBQWEsR0FBcEIsVUFBcUIsTUFBYyxFQUNkLE1BQTRCLEVBQzVCLFVBQThCLEVBQzlCLFVBQXNCO1FBQ3pDLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQztRQUNkLE9BQU8sSUFBVSxNQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUM7WUFDaEQsVUFBVSxFQUFFLFVBQVMsS0FBUyxFQUFDLElBQVc7Z0JBQ3hDLElBQUksTUFBTSxHQUFHLE1BQU0sRUFBRSxDQUFDO2dCQUN0QixJQUFHLENBQUMsTUFBTSxFQUFDO29CQUNULE9BQU8sRUFBRSxDQUFDO2lCQUNYO2dCQUdELElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEVBQUMsS0FBSyxFQUFDLElBQUksQ0FBQyxDQUFDO2dCQUVuRCxJQUFJLEdBQUcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsMkNBQTJDLENBQUM7Z0JBQ3JFLEdBQUcsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLENBQU0sbUJBQW1CO2dCQUNoRCxHQUFHLElBQUksbUJBQW1CLENBQUUsQ0FBQyxZQUFZO2dCQUV6QyxJQUFJLFdBQVcsR0FBRyxVQUFVLENBQUEsQ0FBQyxDQUFBLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQSxDQUFDLENBQUEsRUFBRSxDQUFDO2dCQUNqRCxXQUFXLENBQUMsS0FBSyxHQUFHLFlBQVUsQ0FBQyxVQUFVLENBQUM7Z0JBQzFDLFdBQVcsQ0FBQyxNQUFNLEdBQUcsWUFBVSxDQUFDLFdBQVcsQ0FBQztnQkFDNUMsS0FBSSxJQUFJLEdBQUcsSUFBSSxXQUFXLEVBQUM7b0JBQ3pCLEdBQUcsSUFBSSxHQUFHLEdBQUMsR0FBRyxHQUFDLEdBQUcsR0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ3JDO2dCQUNELEdBQUcsSUFBSSxnQkFBZ0IsQ0FBQyxDQUFLLGtCQUFrQjtnQkFDL0MsT0FBTyxHQUFHLENBQUM7WUFDYixDQUFDO1lBQ0QsUUFBUSxFQUFDLElBQVUsTUFBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVUsQ0FBQyxTQUFTLEVBQUMsWUFBVSxDQUFDLFNBQVMsQ0FBQztZQUN0RixLQUFLLEVBQUMsSUFBSTtZQUNWLE9BQU8sRUFBQyxVQUFVLENBQUEsQ0FBQyxDQUFBLFVBQVUsRUFBRSxDQUFBLENBQUMsQ0FBQSxHQUFHO1NBQ3BDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFBQSxDQUFDOztJQXpFSyxvQkFBUyxHQUFDLEdBQUcsQ0FBQztJQUNkLHFCQUFVLEdBQUMsWUFBVSxDQUFDLFNBQVMsQ0FBQztJQUNoQyxzQkFBVyxHQUFDLFlBQVUsQ0FBQyxTQUFTLENBQUM7SUFKN0IsVUFBVTtRQUR0QixVQUFVLEVBQUU7T0FDQSxVQUFVLENBNkV0QjtJQUFELGlCQUFDO0NBQUEsQUE3RUQsSUE2RUM7U0E3RVksVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbi8vY29uc3QgcHJvajQgPSByZXF1aXJlKCdwcm9qNCcpO1xuLy9jb25zdCBQcm9qID0gcHJvajQuUHJvajtcbi8vY29uc3QgZGVmcyA9IHByb2o0LmRlZnM7XG4vL3Byb2o0LkludGVyZmFjZVByb2plY3Rpb247XG4vL2NvbnN0IEludGVyZmFjZUNvb3JkaW5hdGVzID0gcHJvajQuSW50ZXJmYWNlQ29vcmRpbmF0ZXM7XG4vL2NvbnN0IFRlbXBsYXRlQ29vcmRpbmF0ZXMgPSBwcm9qNC5UZW1wbGF0ZUNvb3JkaW5hdGVzO1xuXG4vL2NvbnN0IHByb2o0ID0gcmVxdWlyZSgncHJvajQnKS5kZWZhdWx0O1xuaW1wb3J0ICogYXMgcHJvajQgZnJvbSAncHJvajQnO1xuY29uc3QgRDJSID0gTWF0aC5QSS8xODA7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBXTVNTZXJ2aWNlIHtcblxuICBzdGF0aWMgVElMRV9TSVpFPTI1NjtcbiAgc3RhdGljIFRJTEVfV0lEVEg9V01TU2VydmljZS5USUxFX1NJWkU7XG4gIHN0YXRpYyBUSUxFX0hFSUdIVD1XTVNTZXJ2aWNlLlRJTEVfU0laRTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLndlYk1lcmNhdG9yID0gKCg8YW55PnByb2o0KS5kZWZhdWx0IHx8IHByb2o0KS5Qcm9qKCdFUFNHOjM4NTcnKTtcbiAgICAvL3RoaXMud2ViTWVyY2F0b3IgPSBwcm9qNC5Qcm9qKHByb2o0LmRlZnMoJ0VQU0c6Mzg1NycpKTtcbiAgfVxuXG4gIHB1YmxpYyB3ZWJNZXJjYXRvcjogYW55O1xuXG4gIHB1YmxpYyBwb2ludFRvV2ViTWVyY2F0b3IocHQ6YW55KTp7eDpudW1iZXIseTpudW1iZXJ9e1xuICAgIHZhciBwdFJhZGlhbnMgPSB7eDpwdC5sbmcoKSpEMlIseTpwdC5sYXQoKSpEMlJ9O1xuICAgIHZhciBwdFdNID0gdGhpcy53ZWJNZXJjYXRvci5mb3J3YXJkKHt4OnB0UmFkaWFucy54LHk6cHRSYWRpYW5zLnl9KTtcbiAgICByZXR1cm4gcHRXTTtcbiAgfTtcblxuICBwdWJsaWMgY29tcHV0ZVRpbGVCb3VuZHMobWFwOmFueSxjb29yZDphbnksem9vbTpudW1iZXIpOnN0cmluZ3tcbiAgICB2YXIgcHJvaiA9IG1hcC5nZXRQcm9qZWN0aW9uKCk7XG4gICAgdmFyIHpmYWN0b3IgPSBNYXRoLnBvdygyLCB6b29tKTtcbiAgICB2YXIgeFNjYWxlID0gV01TU2VydmljZS5USUxFX1dJRFRIL3pmYWN0b3I7XG4gICAgdmFyIHlTY2FsZSA9IFdNU1NlcnZpY2UuVElMRV9IRUlHSFQvemZhY3RvcjtcblxuICAgIHZhciB0b3BMZWZ0TGF0TG5nID0gcHJvai5mcm9tUG9pbnRUb0xhdExuZyh7eDpjb29yZC54ICogeFNjYWxlLCB5OmNvb3JkLnkgKiB5U2NhbGV9KTtcbiAgICB2YXIgYm90dG9tUmlnaHRMYXRMbmcgPSBwcm9qLmZyb21Qb2ludFRvTGF0TG5nKHt4Oihjb29yZC54ICsgMSkgKiB4U2NhbGUsIHk6KGNvb3JkLnkgKyAxKSAqIHlTY2FsZX0pO1xuXG4gICAgdmFyIHRvcExlZnRXZWJNZXJjYXRvciA9IHRoaXMucG9pbnRUb1dlYk1lcmNhdG9yKHRvcExlZnRMYXRMbmcpO1xuICAgIHZhciBib3R0b21SaWdodFdlYk1lcmNhdG9yID0gdGhpcy5wb2ludFRvV2ViTWVyY2F0b3IoYm90dG9tUmlnaHRMYXRMbmcpO1xuXG4gICAgaWYodG9wTGVmdFdlYk1lcmNhdG9yLnggPiBib3R0b21SaWdodFdlYk1lcmNhdG9yLngpe1xuICAgICAgaWYodG9wTGVmdExhdExuZy5sbmcoKT09PTE4MC4wKXtcbiAgICAgICAgdG9wTGVmdFdlYk1lcmNhdG9yLnggPSAtdG9wTGVmdFdlYk1lcmNhdG9yLng7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBib3R0b21SaWdodFdlYk1lcmNhdG9yLnggPSAtYm90dG9tUmlnaHRXZWJNZXJjYXRvci54O1xuICAgICAgfVxuICAgIH1cbiAgICB2YXIgYmJveCA9IFt0b3BMZWZ0V2ViTWVyY2F0b3IueCxib3R0b21SaWdodFdlYk1lcmNhdG9yLnksYm90dG9tUmlnaHRXZWJNZXJjYXRvci54LHRvcExlZnRXZWJNZXJjYXRvci55XTtcbiAgICB2YXIgYmJveFR4dCA9IGJib3gubWFwKChuKT0+bi50b0ZpeGVkKDIwKS5yZXBsYWNlKC9cXC4/MCskLyxcIlwiKSk7IC8vIEF2b2lkIGUgbm90YXRpb24gb24gc21hbGwgbnVtYmVyc1xuICAgIHJldHVybiBiYm94VHh0LmpvaW4oJywnKTtcbiAgfTtcblxuICBwdWJsaWMgYnVpbGRJbWFnZU1hcChnZXRNYXA6KCk9PmFueSxcbiAgICAgICAgICAgICAgICAgICAgICAgZ2V0VVJMOih6b29tOm51bWJlcik9PnN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgZ2V0T3B0aW9ucz86KHpvb206bnVtYmVyKT0+YW55LFxuICAgICAgICAgICAgICAgICAgICAgICBnZXRPcGFjaXR5PzooKT0+bnVtYmVyKTphbnl7XG4gICAgdmFyIG1lID0gdGhpcztcbiAgICByZXR1cm4gbmV3ICg8YW55PndpbmRvdykuZ29vZ2xlLm1hcHMuSW1hZ2VNYXBUeXBlKHtcbiAgICAgIGdldFRpbGVVcmw6IGZ1bmN0aW9uKGNvb3JkOmFueSx6b29tOm51bWJlcik6c3RyaW5ne1xuICAgICAgICB2YXIgdGhlTWFwID0gZ2V0TWFwKCk7XG4gICAgICAgIGlmKCF0aGVNYXApe1xuICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuXG5cbiAgICAgICAgdmFyIGJib3ggPSBtZS5jb21wdXRlVGlsZUJvdW5kcyh0aGVNYXAsY29vcmQsem9vbSk7XG5cbiAgICAgICAgdmFyIHVybCA9IGdldFVSTCh6b29tKSArICcmc2VydmljZT1XTVMmdmVyc2lvbj0xLjEuMSZyZXF1ZXN0PUdldE1hcCc7XG4gICAgICAgIHVybCArPSBcIiZCQk9YPVwiICsgYmJveDsgICAgICAvLyBzZXQgYm91bmRpbmcgYm94XG4gICAgICAgIHVybCArPSBcIiZGT1JNQVQ9aW1hZ2UvcG5nXCIgOyAvL1dNUyBmb3JtYXRcblxuICAgICAgICB2YXIgbGF5ZXJQYXJhbXMgPSBnZXRPcHRpb25zP2dldE9wdGlvbnMoem9vbSk6e307XG4gICAgICAgIGxheWVyUGFyYW1zLndpZHRoID0gV01TU2VydmljZS5USUxFX1dJRFRIO1xuICAgICAgICBsYXllclBhcmFtcy5oZWlnaHQgPSBXTVNTZXJ2aWNlLlRJTEVfSEVJR0hUO1xuICAgICAgICBmb3IodmFyIGtleSBpbiBsYXllclBhcmFtcyl7XG4gICAgICAgICAgdXJsICs9ICcmJytrZXkrJz0nK2xheWVyUGFyYW1zW2tleV07XG4gICAgICAgIH1cbiAgICAgICAgdXJsICs9IFwiJlNSUz1FUFNHOjM4NTdcIjsgICAgIC8vc2V0IFdlYiBNZXJjYXRvclxuICAgICAgICByZXR1cm4gdXJsO1xuICAgICAgfSxcbiAgICAgIHRpbGVTaXplOm5ldyAoPGFueT53aW5kb3cpLmdvb2dsZS5tYXBzLlNpemUoV01TU2VydmljZS5USUxFX1NJWkUsV01TU2VydmljZS5USUxFX1NJWkUpLFxuICAgICAgaXNQbmc6dHJ1ZSxcbiAgICAgIG9wYWNpdHk6Z2V0T3BhY2l0eT9nZXRPcGFjaXR5KCk6MS4wXG4gICAgfSk7XG4gIH07XG5cbn1cbiJdfQ==