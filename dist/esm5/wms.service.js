import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
//const proj4 = require('proj4');
//const Proj = proj4.Proj;
//const defs = proj4.defs;
//proj4.InterfaceProjection;
//const InterfaceCoordinates = proj4.InterfaceCoordinates;
//const TemplateCoordinates = proj4.TemplateCoordinates;
//const proj4 = require('proj4').default;
import * as proj4 from 'proj4';
var D2R = Math.PI / 180;
var WMSService = /** @class */ (function () {
    function WMSService() {
        this.webMercator = (proj4.default || proj4).Proj('EPSG:3857');
        //this.webMercator = proj4.Proj(proj4.defs('EPSG:3857'));
    }
    WMSService_1 = WMSService;
    WMSService.prototype.pointToWebMercator = function (pt) {
        var ptRadians = { x: pt.lng() * D2R, y: pt.lat() * D2R };
        var ptWM = this.webMercator.forward({ x: ptRadians.x, y: ptRadians.y });
        return ptWM;
    };
    ;
    WMSService.prototype.computeTileBounds = function (map, coord, zoom) {
        var proj = map.getProjection();
        var zfactor = Math.pow(2, zoom);
        var xScale = WMSService_1.TILE_WIDTH / zfactor;
        var yScale = WMSService_1.TILE_HEIGHT / zfactor;
        var topLeftLatLng = proj.fromPointToLatLng({ x: coord.x * xScale, y: coord.y * yScale });
        var bottomRightLatLng = proj.fromPointToLatLng({ x: (coord.x + 1) * xScale, y: (coord.y + 1) * yScale });
        var topLeftWebMercator = this.pointToWebMercator(topLeftLatLng);
        var bottomRightWebMercator = this.pointToWebMercator(bottomRightLatLng);
        if (topLeftWebMercator.x > bottomRightWebMercator.x) {
            if (topLeftLatLng.lng() === 180.0) {
                topLeftWebMercator.x = -topLeftWebMercator.x;
            }
            else {
                bottomRightWebMercator.x = -bottomRightWebMercator.x;
            }
        }
        var bbox = [topLeftWebMercator.x, bottomRightWebMercator.y, bottomRightWebMercator.x, topLeftWebMercator.y];
        var bboxTxt = bbox.map(function (n) { return n.toFixed(20).replace(/\.?0+$/, ""); }); // Avoid e notation on small numbers
        return bboxTxt.join(',');
    };
    ;
    WMSService.prototype.buildImageMap = function (getMap, getURL, getOptions, getOpacity) {
        var me = this;
        return new window.google.maps.ImageMapType({
            getTileUrl: function (coord, zoom) {
                var theMap = getMap();
                if (!theMap) {
                    return '';
                }
                var bbox = me.computeTileBounds(theMap, coord, zoom);
                var url = getURL(zoom) + '&service=WMS&version=1.1.1&request=GetMap';
                url += "&BBOX=" + bbox; // set bounding box
                url += "&FORMAT=image/png"; //WMS format
                var layerParams = getOptions ? getOptions(zoom) : {};
                layerParams.width = WMSService_1.TILE_WIDTH;
                layerParams.height = WMSService_1.TILE_HEIGHT;
                for (var key in layerParams) {
                    url += '&' + key + '=' + layerParams[key];
                }
                url += "&SRS=EPSG:3857"; //set Web Mercator
                return url;
            },
            tileSize: new window.google.maps.Size(WMSService_1.TILE_SIZE, WMSService_1.TILE_SIZE),
            isPng: true,
            opacity: getOpacity ? getOpacity() : 1.0
        });
    };
    ;
    var WMSService_1;
    WMSService.TILE_SIZE = 256;
    WMSService.TILE_WIDTH = WMSService_1.TILE_SIZE;
    WMSService.TILE_HEIGHT = WMSService_1.TILE_SIZE;
    WMSService = WMSService_1 = tslib_1.__decorate([
        Injectable(),
        tslib_1.__metadata("design:paramtypes", [])
    ], WMSService);
    return WMSService;
}());
export { WMSService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid21zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9tYXAtd2FsZC8iLCJzb3VyY2VzIjpbIndtcy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLGlDQUFpQztBQUNqQywwQkFBMEI7QUFDMUIsMEJBQTBCO0FBQzFCLDRCQUE0QjtBQUM1QiwwREFBMEQ7QUFDMUQsd0RBQXdEO0FBRXhELHlDQUF5QztBQUN6QyxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMvQixJQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsRUFBRSxHQUFDLEdBQUcsQ0FBQztBQUd4QjtJQU1FO1FBQ0UsSUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFPLEtBQU0sQ0FBQyxPQUFPLElBQUksS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3JFLHlEQUF5RDtJQUMzRCxDQUFDO21CQVRVLFVBQVU7SUFhZCx1Q0FBa0IsR0FBekIsVUFBMEIsRUFBTTtRQUM5QixJQUFJLFNBQVMsR0FBRyxFQUFDLENBQUMsRUFBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUMsR0FBRyxFQUFDLENBQUMsRUFBQyxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUMsR0FBRyxFQUFDLENBQUM7UUFDaEQsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsRUFBQyxDQUFDLEVBQUMsU0FBUyxDQUFDLENBQUMsRUFBQyxDQUFDLEVBQUMsU0FBUyxDQUFDLENBQUMsRUFBQyxDQUFDLENBQUM7UUFDbkUsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBQUEsQ0FBQztJQUVLLHNDQUFpQixHQUF4QixVQUF5QixHQUFPLEVBQUMsS0FBUyxFQUFDLElBQVc7UUFDcEQsSUFBSSxJQUFJLEdBQUcsR0FBRyxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQy9CLElBQUksT0FB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QUFVLENBQUM7Z0JBQzFDLFdBQVcsQ0FBQyxNQUFNLEdBQUcsWUFBVSxDQUFDLFdBQVcsQ0FBQztnQkFDNUMsS0FBSSxJQUFJLEdBQUcsSUFBSSxXQUFXLEVBQUM7b0JBQ3pCLEdBQUcsSUFBSSxHQUFHLEdBQUMsR0FBRyxHQUFDLEdBQUcsR0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ3JDO2dCQUNELEdBQUcsSUFBSSxnQkFBZ0IsQ0FBQyxDQUFLLGtCQUFrQjtnQkFDL0MsT0FBTyxHQUFHLENBQUM7WUFDYixDQUFDO1lBQ0QsUUFBUSxFQUFDLElBQVUsTUFBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVUsQ0FBQyxTQUFTLEVBQUMsWUFBVSxDQUFDLFNBQVMsQ0FBQztZQUN0RixLQUFLLEVBQUMsSUFBSTtZQUNWLE9BQU8sRUFBQyxVQUFVLENBQUEsQ0FBQyxDQUFBLFVBQVUsRUFBRSxDQUFBLENBQUMsQ0FBQSxHQUFHO1NBQ3BDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFBQSxDQUFDOztJQXpFSyxvQkFBUyxHQUFDLEdBQUcsQ0FBQztJQUNkLHFCQUFVLEdBQUMsWUFBVSxDQUFDLFNBQVMsQ0FBQztJQUNoQyxzQkFBVyxHQUFDLFlBQVUsQ0FBQyxTQUFTLENBQUM7SUFKN0IsVUFBVTtRQUR0QixVQUFVLEVBQUU7O09BQ0EsVUFBVSxDQTZFdEI7SUFBRCxpQkFBQztDQUFBLEFBN0VELElBNkVDO1NBN0VZLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG4vL2NvbnN0IHByb2o0ID0gcmVxdWlyZSgncHJvajQnKTtcbi8vY29uc3QgUHJvaiA9IHByb2o0LlByb2o7XG4vL2NvbnN0IGRlZnMgPSBwcm9qNC5kZWZzO1xuLy9wcm9qNC5JbnRlcmZhY2VQcm9qZWN0aW9uO1xuLy9jb25zdCBJbnRlcmZhY2VDb29yZGluYXRlcyA9IHByb2o0LkludGVyZmFjZUNvb3JkaW5hdGVzO1xuLy9jb25zdCBUZW1wbGF0ZUNvb3JkaW5hdGVzID0gcHJvajQuVGVtcGxhdGVDb29yZGluYXRlcztcblxuLy9jb25zdCBwcm9qNCA9IHJlcXVpcmUoJ3Byb2o0JykuZGVmYXVsdDtcbmltcG9ydCAqIGFzIHByb2o0IGZyb20gJ3Byb2o0JztcbmNvbnN0IEQyUiA9IE1hdGguUEkvMTgwO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgV01TU2VydmljZSB7XG5cbiAgc3RhdGljIFRJTEVfU0laRT0yNTY7XG4gIHN0YXRpYyBUSUxFX1dJRFRIPVdNU1NlcnZpY2UuVElMRV9TSVpFO1xuICBzdGF0aWMgVElMRV9IRUlHSFQ9V01TU2VydmljZS5USUxFX1NJWkU7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy53ZWJNZXJjYXRvciA9ICgoPGFueT5wcm9qNCkuZGVmYXVsdCB8fCBwcm9qNCkuUHJvaignRVBTRzozODU3Jyk7XG4gICAgLy90aGlzLndlYk1lcmNhdG9yID0gcHJvajQuUHJvaihwcm9qNC5kZWZzKCdFUFNHOjM4NTcnKSk7XG4gIH1cblxuICBwdWJsaWMgd2ViTWVyY2F0b3I6IGFueTtcblxuICBwdWJsaWMgcG9pbnRUb1dlYk1lcmNhdG9yKHB0OmFueSk6e3g6bnVtYmVyLHk6bnVtYmVyfXtcbiAgICB2YXIgcHRSYWRpYW5zID0ge3g6cHQubG5nKCkqRDJSLHk6cHQubGF0KCkqRDJSfTtcbiAgICB2YXIgcHRXTSA9IHRoaXMud2ViTWVyY2F0b3IuZm9yd2FyZCh7eDpwdFJhZGlhbnMueCx5OnB0UmFkaWFucy55fSk7XG4gICAgcmV0dXJuIHB0V007XG4gIH07XG5cbiAgcHVibGljIGNvbXB1dGVUaWxlQm91bmRzKG1hcDphbnksY29vcmQ6YW55LHpvb206bnVtYmVyKTpzdHJpbmd7XG4gICAgdmFyIHByb2ogPSBtYXAuZ2V0UHJvamVjdGlvbigpO1xuICAgIHZhciB6ZmFjdG9yID0gTWF0aC5wb3coMiwgem9vbSk7XG4gICAgdmFyIHhTY2FsZSA9IFdNU1NlcnZpY2UuVElMRV9XSURUSC96ZmFjdG9yO1xuICAgIHZhciB5U2NhbGUgPSBXTVNTZXJ2aWNlLlRJTEVfSEVJR0hUL3pmYWN0b3I7XG5cbiAgICB2YXIgdG9wTGVmdExhdExuZyA9IHByb2ouZnJvbVBvaW50VG9MYXRMbmcoe3g6Y29vcmQueCAqIHhTY2FsZSwgeTpjb29yZC55ICogeVNjYWxlfSk7XG4gICAgdmFyIGJvdHRvbVJpZ2h0TGF0TG5nID0gcHJvai5mcm9tUG9pbnRUb0xhdExuZyh7eDooY29vcmQueCArIDEpICogeFNjYWxlLCB5Oihjb29yZC55ICsgMSkgKiB5U2NhbGV9KTtcblxuICAgIHZhciB0b3BMZWZ0V2ViTWVyY2F0b3IgPSB0aGlzLnBvaW50VG9XZWJNZXJjYXRvcih0b3BMZWZ0TGF0TG5nKTtcbiAgICB2YXIgYm90dG9tUmlnaHRXZWJNZXJjYXRvciA9IHRoaXMucG9pbnRUb1dlYk1lcmNhdG9yKGJvdHRvbVJpZ2h0TGF0TG5nKTtcblxuICAgIGlmKHRvcExlZnRXZWJNZXJjYXRvci54ID4gYm90dG9tUmlnaHRXZWJNZXJjYXRvci54KXtcbiAgICAgIGlmKHRvcExlZnRMYXRMbmcubG5nKCk9PT0xODAuMCl7XG4gICAgICAgIHRvcExlZnRXZWJNZXJjYXRvci54ID0gLXRvcExlZnRXZWJNZXJjYXRvci54O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYm90dG9tUmlnaHRXZWJNZXJjYXRvci54ID0gLWJvdHRvbVJpZ2h0V2ViTWVyY2F0b3IueDtcbiAgICAgIH1cbiAgICB9XG4gICAgdmFyIGJib3ggPSBbdG9wTGVmdFdlYk1lcmNhdG9yLngsYm90dG9tUmlnaHRXZWJNZXJjYXRvci55LGJvdHRvbVJpZ2h0V2ViTWVyY2F0b3IueCx0b3BMZWZ0V2ViTWVyY2F0b3IueV07XG4gICAgdmFyIGJib3hUeHQgPSBiYm94Lm1hcCgobik9Pm4udG9GaXhlZCgyMCkucmVwbGFjZSgvXFwuPzArJC8sXCJcIikpOyAvLyBBdm9pZCBlIG5vdGF0aW9uIG9uIHNtYWxsIG51bWJlcnNcbiAgICByZXR1cm4gYmJveFR4dC5qb2luKCcsJyk7XG4gIH07XG5cbiAgcHVibGljIGJ1aWxkSW1hZ2VNYXAoZ2V0TWFwOigpPT5hbnksXG4gICAgICAgICAgICAgICAgICAgICAgIGdldFVSTDooem9vbTpudW1iZXIpPT5zdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgIGdldE9wdGlvbnM/Oih6b29tOm51bWJlcik9PmFueSxcbiAgICAgICAgICAgICAgICAgICAgICAgZ2V0T3BhY2l0eT86KCk9Pm51bWJlcik6YW55e1xuICAgIHZhciBtZSA9IHRoaXM7XG4gICAgcmV0dXJuIG5ldyAoPGFueT53aW5kb3cpLmdvb2dsZS5tYXBzLkltYWdlTWFwVHlwZSh7XG4gICAgICBnZXRUaWxlVXJsOiBmdW5jdGlvbihjb29yZDphbnksem9vbTpudW1iZXIpOnN0cmluZ3tcbiAgICAgICAgdmFyIHRoZU1hcCA9IGdldE1hcCgpO1xuICAgICAgICBpZighdGhlTWFwKXtcbiAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cblxuXG4gICAgICAgIHZhciBiYm94ID0gbWUuY29tcHV0ZVRpbGVCb3VuZHModGhlTWFwLGNvb3JkLHpvb20pO1xuXG4gICAgICAgIHZhciB1cmwgPSBnZXRVUkwoem9vbSkgKyAnJnNlcnZpY2U9V01TJnZlcnNpb249MS4xLjEmcmVxdWVzdD1HZXRNYXAnO1xuICAgICAgICB1cmwgKz0gXCImQkJPWD1cIiArIGJib3g7ICAgICAgLy8gc2V0IGJvdW5kaW5nIGJveFxuICAgICAgICB1cmwgKz0gXCImRk9STUFUPWltYWdlL3BuZ1wiIDsgLy9XTVMgZm9ybWF0XG5cbiAgICAgICAgdmFyIGxheWVyUGFyYW1zID0gZ2V0T3B0aW9ucz9nZXRPcHRpb25zKHpvb20pOnt9O1xuICAgICAgICBsYXllclBhcmFtcy53aWR0aCA9IFdNU1NlcnZpY2UuVElMRV9XSURUSDtcbiAgICAgICAgbGF5ZXJQYXJhbXMuaGVpZ2h0ID0gV01TU2VydmljZS5USUxFX0hFSUdIVDtcbiAgICAgICAgZm9yKHZhciBrZXkgaW4gbGF5ZXJQYXJhbXMpe1xuICAgICAgICAgIHVybCArPSAnJicra2V5Kyc9JytsYXllclBhcmFtc1trZXldO1xuICAgICAgICB9XG4gICAgICAgIHVybCArPSBcIiZTUlM9RVBTRzozODU3XCI7ICAgICAvL3NldCBXZWIgTWVyY2F0b3JcbiAgICAgICAgcmV0dXJuIHVybDtcbiAgICAgIH0sXG4gICAgICB0aWxlU2l6ZTpuZXcgKDxhbnk+d2luZG93KS5nb29nbGUubWFwcy5TaXplKFdNU1NlcnZpY2UuVElMRV9TSVpFLFdNU1NlcnZpY2UuVElMRV9TSVpFKSxcbiAgICAgIGlzUG5nOnRydWUsXG4gICAgICBvcGFjaXR5OmdldE9wYWNpdHk/Z2V0T3BhY2l0eSgpOjEuMFxuICAgIH0pO1xuICB9O1xuXG59XG4iXX0=