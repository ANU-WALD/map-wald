import { InterpolationService } from '../interpolation.service';
const PUBLICATION_PRIORITY_ORDER = [
    'annual',
    'monthly',
    'daily'
];
const ɵ0 = (host, fn) => {
    let components = fn.split('/');
    components.pop();
    return `${host}/catalog/${components.join('/')}/catalog.html`;
}, ɵ1 = (host, fn, ml) => {
    return ml.layer.options.downloadPath || `${host}${fn}`;
};
const MAKE_DOWNLOAD_URL = {
    tds: ɵ0,
    static: ɵ1
};
export const WMS_PARAMETER_NAMES = {
    tds: [
        'layers',
        'styles',
        'colorscalerange',
        'abovemaxcolor',
        'belowmincolor',
        'time',
        'transparent',
        'logscale'
    ],
    geoserver: [
        'transparent',
        'layers'
    ],
    esri: [
        'layers',
        'styles',
        'transparent'
    ]
};
export const WMS_URL_FORMAT = {
    tds: '/wms/',
    geoserver: '/wms/',
    esri: '/'
};
export const INTERPOLATED_PARAMETERS = [
    'styles',
    'layers'
];
export class MappedLayer {
    constructor(data) {
        this.options = {
            date: new Date(2016, 0, 1) // Set to most recent available date
        };
        this.retrievedMetadata = {};
        this.wmsParameters = {};
        this.flattenedSettings = {};
        this.opacity = 1.0;
        Object.assign(this, data || {});
        if (this.layerType === undefined) {
            this.layerType = this.wmsParameters ? 'wms' : undefined;
        }
    }
    description() {
        return this.layer.description ||
            (this.retrievedMetadata &&
                this.retrievedMetadata[this.layer.descriptionField || 'long_name']);
    }
    leading0(n) {
        if (n < 10) {
            return '0' + n;
        }
        return '' + n;
    }
    defaultPublication() {
        const priorityPublication = PUBLICATION_PRIORITY_ORDER.find(pp => this.layer.publications.findIndex(lp => (lp.timestep === pp) || (lp.label === pp)) >= 0);
        if (priorityPublication) {
            return this.layer.publications.findIndex(p => (p.label === priorityPublication) || (p.timestep === priorityPublication));
        }
        return this.layer.publications.findIndex(p => !p.skip);
    }
    update() {
        this.options.publication = (this.options.publication === undefined) ?
            this.defaultPublication() :
            this.options.publication;
        const publication = this.layer.publications[this.options.publication];
        const host = publication.options.host || {};
        const baseURL = host.url;
        const software = host.software || 'tds';
        this.interpolatedFile = (publication.options.filepath || '');
        const mapParams = Object.assign({}, this.layer, publication.options, publication.options.mapOptions || {}, this.options.date ? {
            decade: decadeText(this.options.date),
            year: this.options.date.getFullYear(),
            month: this.leading0(this.options.date.getMonth() + 1),
            day: this.leading0(this.options.date.getDate()),
        } : {}, this.options, this.options.tags || {});
        if (mapParams.timeFormat) {
            mapParams['time'] = InterpolationService.interpolate(mapParams.timeFormat, mapParams);
        }
        mapParams.layers = mapParams.layers || mapParams.layer || mapParams.variable;
        INTERPOLATED_PARAMETERS.forEach(p => {
            if (mapParams[p]) {
                mapParams[p] = InterpolationService.interpolate(mapParams[p], mapParams);
            }
        });
        this.interpolatedFile = InterpolationService.interpolate(this.interpolatedFile, mapParams);
        this.url = baseURL + WMS_URL_FORMAT[software] + this.interpolatedFile;
        if (MAKE_DOWNLOAD_URL[software]) {
            this.interpolatedDownloadURL = MAKE_DOWNLOAD_URL[software](host.downloadLink || baseURL, this.interpolatedFile, this);
        }
        else {
            this.interpolatedDownloadURL = host.downloadLink || null;
        }
        if (this.layer.options.legend === 'wms') {
            this.legendURL = this.url + '?service=WMS&request=GetLegendGraphic&format=image/png';
            this.legendURL += `&layer=${InterpolationService.interpolate(mapParams.layers, mapParams)}`;
            this.legendURL += '&version=1.1.1';
            this.options.legend = true;
        }
        else {
            this.legendURL = null;
        }
        if (mapParams.vectors) {
            this.wmsParameters = null;
            this.layerType = 'vector';
            let styles = mapParams.styles || {};
            this._styleFunc = (f) => {
                return styles;
            };
            if (mapParams.vectors === 'point' && mapParams.styles) {
                this.layerType = 'circle';
            }
        }
        else {
            this.layerType = 'wms';
            this.wmsParameters = {};
            WMS_PARAMETER_NAMES[software].forEach(param => {
                if (mapParams[param]) {
                    this.wmsParameters[param] = mapParams[param];
                }
            });
        }
        this.flattenedSettings = mapParams;
        if (mapParams.titleFormat) {
            this.title = InterpolationService.interpolate(mapParams.titleFormat, mapParams);
        }
        else {
            this.title = this.layer.name;
        }
    }
}
function decadeText(d) {
    let decade = d.getFullYear().toString().slice(0, 3);
    return `${decade}0-${decade}9`;
}
export { ɵ0, ɵ1 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFwcGVkLWxheWVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbWFwLXdhbGQvIiwic291cmNlcyI6WyJkYXRhL21hcHBlZC1sYXllci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQVloRSxNQUFNLDBCQUEwQixHQUFHO0lBQ2pDLFFBQVE7SUFDUixTQUFTO0lBQ1QsT0FBTztDQUNSLENBQUM7V0FHSSxDQUFDLElBQVcsRUFBQyxFQUFTLEVBQUMsRUFBRTtJQUMzQixJQUFJLFVBQVUsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQy9CLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUNqQixPQUFPLEdBQUcsSUFBSSxZQUFZLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQztBQUNoRSxDQUFDLE9BQ00sQ0FBQyxJQUFXLEVBQUMsRUFBUyxFQUFDLEVBQWMsRUFBQyxFQUFFO0lBQzdDLE9BQU8sRUFBRSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsWUFBWSxJQUFJLEdBQUcsSUFBSSxHQUFHLEVBQUUsRUFBRSxDQUFDO0FBQ3pELENBQUM7QUFSSCxNQUFNLGlCQUFpQixHQUE2RDtJQUNsRixHQUFHLElBSUY7SUFDRCxNQUFNLElBRUw7Q0FDRixDQUFBO0FBRUQsTUFBTSxDQUFDLE1BQU0sbUJBQW1CLEdBQWdDO0lBQzlELEdBQUcsRUFBRTtRQUNILFFBQVE7UUFDUixRQUFRO1FBQ1IsaUJBQWlCO1FBQ2pCLGVBQWU7UUFDZixlQUFlO1FBQ2YsTUFBTTtRQUNOLGFBQWE7UUFDYixVQUFVO0tBQ1g7SUFDRCxTQUFTLEVBQUU7UUFDVCxhQUFhO1FBQ2IsUUFBUTtLQUNUO0lBQ0QsSUFBSSxFQUFFO1FBQ0osUUFBUTtRQUNSLFFBQVE7UUFDUixhQUFhO0tBQ2Q7Q0FDRixDQUFDO0FBRUYsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUF5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SUFDekIsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDcEQsT0FBTyxHQUFHLE1BQU0sS0FBSyxNQUFNLEdBQUcsQ0FBQztBQUNqQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTGF5ZXIgfSBmcm9tICcuL2NhdGFsb2cnO1xuaW1wb3J0IHsgSW50ZXJwb2xhdGlvblNlcnZpY2UgfSBmcm9tICcuLi9pbnRlcnBvbGF0aW9uLnNlcnZpY2UnO1xuXG5leHBvcnQgdHlwZSBNYXBwZWRMYXllclR5cGVzID0gJ3dtcycgfCAndmVjdG9yJyB8ICdjaXJjbGUnO1xuXG5leHBvcnQgaW50ZXJmYWNlIE1hcHBlZExheWVyT3B0aW9ucyB7XG4gIGxlZ2VuZD86IGJvb2xlYW47XG4gIHB1YmxpY2F0aW9uPzogbnVtYmVyO1xuICBkYXRlPzogRGF0ZSxcblxuICBba2V5OiBzdHJpbmddOiBhbnk7XG59XG5cbmNvbnN0IFBVQkxJQ0FUSU9OX1BSSU9SSVRZX09SREVSID0gW1xuICAnYW5udWFsJyxcbiAgJ21vbnRobHknLFxuICAnZGFpbHknXG5dO1xuXG5jb25zdCBNQUtFX0RPV05MT0FEX1VSTDp7W2tleTpzdHJpbmddOihhOnN0cmluZyxzOnN0cmluZyxtbDpNYXBwZWRMYXllcik9PnN0cmluZ30gPSB7XG4gIHRkczooaG9zdDpzdHJpbmcsZm46c3RyaW5nKT0+e1xuICAgIGxldCBjb21wb25lbnRzID0gZm4uc3BsaXQoJy8nKTtcbiAgICBjb21wb25lbnRzLnBvcCgpO1xuICAgIHJldHVybiBgJHtob3N0fS9jYXRhbG9nLyR7Y29tcG9uZW50cy5qb2luKCcvJyl9L2NhdGFsb2cuaHRtbGA7XG4gIH0sXG4gIHN0YXRpYzooaG9zdDpzdHJpbmcsZm46c3RyaW5nLG1sOk1hcHBlZExheWVyKT0+e1xuICAgIHJldHVybiBtbC5sYXllci5vcHRpb25zLmRvd25sb2FkUGF0aCB8fCBgJHtob3N0fSR7Zm59YDtcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgV01TX1BBUkFNRVRFUl9OQU1FUzp7W2tleTpzdHJpbmddOkFycmF5PHN0cmluZz59ID0ge1xuICB0ZHM6IFtcbiAgICAnbGF5ZXJzJyxcbiAgICAnc3R5bGVzJyxcbiAgICAnY29sb3JzY2FsZXJhbmdlJyxcbiAgICAnYWJvdmVtYXhjb2xvcicsXG4gICAgJ2JlbG93bWluY29sb3InLFxuICAgICd0aW1lJyxcbiAgICAndHJhbnNwYXJlbnQnLFxuICAgICdsb2dzY2FsZSdcbiAgXSxcbiAgZ2Vvc2VydmVyOiBbXG4gICAgJ3RyYW5zcGFyZW50JyxcbiAgICAnbGF5ZXJzJ1xuICBdLFxuICBlc3JpOiBbXG4gICAgJ2xheWVycycsXG4gICAgJ3N0eWxlcycsXG4gICAgJ3RyYW5zcGFyZW50J1xuICBdXG59O1xuXG5leHBvcnQgY29uc3QgV01TX1VSTF9GT1JNQVQ6e1trZXk6c3RyaW5nXTpzdHJpbmd9ID0ge1xuICB0ZHM6Jy93bXMvJyxcbiAgZ2Vvc2VydmVyOicvd21zLycsXG4gIGVzcmk6Jy8nXG59O1xuXG5leHBvcnQgY29uc3QgSU5URVJQT0xBVEVEX1BBUkFNRVRFUlMgPSBbXG4gICdzdHlsZXMnLFxuICAnbGF5ZXJzJ1xuXTtcblxuZXhwb3J0IGNsYXNzIE1hcHBlZExheWVyIHtcbiAgY29uc3RydWN0b3IoZGF0YT86YW55KXtcbiAgICBPYmplY3QuYXNzaWduKHRoaXMsZGF0YXx8e30pO1xuICAgIGlmKHRoaXMubGF5ZXJUeXBlPT09dW5kZWZpbmVkKXtcbiAgICAgIHRoaXMubGF5ZXJUeXBlID0gdGhpcy53bXNQYXJhbWV0ZXJzPyd3bXMnOnVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICB0aXRsZTpzdHJpbmc7XG5cbiAgbGF5ZXI6IExheWVyO1xuICBvcHRpb25zOiBNYXBwZWRMYXllck9wdGlvbnMgPSB7XG4gICAgZGF0ZTogbmV3IERhdGUoMjAxNiwgMCwgMSkgLy8gU2V0IHRvIG1vc3QgcmVjZW50IGF2YWlsYWJsZSBkYXRlXG4gIH07XG5cbiAgbGVnZW5kVVJMOnN0cmluZztcbiAgbGF5ZXJUeXBlOiBNYXBwZWRMYXllclR5cGVzO1xuICByZXRyaWV2ZWRNZXRhZGF0YToge1trZXk6c3RyaW5nXTphbnl9ID0ge307XG5cbiAgaW50ZXJwb2xhdGVkRmlsZTpzdHJpbmc7XG4gIGludGVycG9sYXRlZERvd25sb2FkVVJMOnN0cmluZztcbiAgdXJsOiBzdHJpbmc7XG4gIHdtc1BhcmFtZXRlcnM6IGFueSA9IHt9O1xuICBmbGF0dGVuZWRTZXR0aW5nczogYW55ID0ge307XG4gIHN0YXRpY0RhdGE6YW55O1xuICBvcGFjaXR5ID0gMS4wO1xuXG4gIF9zdHlsZUZ1bmM6IChmOmFueSk9PnZvaWQ7XG5cbiAgZGVzY3JpcHRpb24oKTpzdHJpbmd7XG4gICAgcmV0dXJuIHRoaXMubGF5ZXIuZGVzY3JpcHRpb24gfHxcbiAgICAgICh0aGlzLnJldHJpZXZlZE1ldGFkYXRhICYmXG4gICAgICAgdGhpcy5yZXRyaWV2ZWRNZXRhZGF0YVt0aGlzLmxheWVyLmRlc2NyaXB0aW9uRmllbGR8fCdsb25nX25hbWUnXSk7XG4gIH1cblxuICBsZWFkaW5nMChuOiBudW1iZXIpOiBzdHJpbmcge1xuICAgIGlmIChuIDwgMTApIHtcbiAgICAgIHJldHVybiAnMCcgKyBuO1xuICAgIH1cbiAgICByZXR1cm4gJycgKyBuO1xuICB9XG5cbiAgZGVmYXVsdFB1YmxpY2F0aW9uKCk6bnVtYmVye1xuICAgIGNvbnN0IHByaW9yaXR5UHVibGljYXRpb24gPSBQVUJMSUNBVElPTl9QUklPUklUWV9PUkRFUi5maW5kKFxuICAgICAgcHA9PnRoaXMubGF5ZXIucHVibGljYXRpb25zLmZpbmRJbmRleChscD0+KGxwLnRpbWVzdGVwPT09cHApfHwobHAubGFiZWw9PT1wcCkpPj0wKTtcbiAgICBpZihwcmlvcml0eVB1YmxpY2F0aW9uKXtcbiAgICAgIHJldHVybiB0aGlzLmxheWVyLnB1YmxpY2F0aW9ucy5maW5kSW5kZXgocD0+KHAubGFiZWw9PT1wcmlvcml0eVB1YmxpY2F0aW9uKXx8KHAudGltZXN0ZXA9PT1wcmlvcml0eVB1YmxpY2F0aW9uKSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmxheWVyLnB1YmxpY2F0aW9ucy5maW5kSW5kZXgocCA9PiAhcC5za2lwKTtcbiAgfVxuXG4gIHVwZGF0ZSgpIHtcbiAgICB0aGlzLm9wdGlvbnMucHVibGljYXRpb24gPSAodGhpcy5vcHRpb25zLnB1YmxpY2F0aW9uID09PSB1bmRlZmluZWQpID9cbiAgICAgIHRoaXMuZGVmYXVsdFB1YmxpY2F0aW9uKCkgOlxuICAgICAgdGhpcy5vcHRpb25zLnB1YmxpY2F0aW9uO1xuXG4gICAgY29uc3QgcHVibGljYXRpb24gPSB0aGlzLmxheWVyLnB1YmxpY2F0aW9uc1t0aGlzLm9wdGlvbnMucHVibGljYXRpb25dO1xuXG4gICAgY29uc3QgaG9zdCA9IHB1YmxpY2F0aW9uLm9wdGlvbnMuaG9zdCB8fCB7fTtcbiAgICBjb25zdCBiYXNlVVJMID0gaG9zdC51cmw7XG5cbiAgICBjb25zdCBzb2Z0d2FyZSA9IGhvc3Quc29mdHdhcmUgfHwgJ3Rkcyc7XG5cbiAgICB0aGlzLmludGVycG9sYXRlZEZpbGUgPSAocHVibGljYXRpb24ub3B0aW9ucy5maWxlcGF0aCB8fCAnJylcbiAgICBjb25zdCBtYXBQYXJhbXMgPSBPYmplY3QuYXNzaWduKHt9LFxuICAgICAgdGhpcy5sYXllcixcbiAgICAgIHB1YmxpY2F0aW9uLm9wdGlvbnMsXG4gICAgICBwdWJsaWNhdGlvbi5vcHRpb25zLm1hcE9wdGlvbnMgfHwge30sXG4gICAgICB0aGlzLm9wdGlvbnMuZGF0ZSA/IHtcbiAgICAgICAgZGVjYWRlOiBkZWNhZGVUZXh0KHRoaXMub3B0aW9ucy5kYXRlKSxcbiAgICAgICAgeWVhcjogdGhpcy5vcHRpb25zLmRhdGUuZ2V0RnVsbFllYXIoKSxcbiAgICAgICAgbW9udGg6IHRoaXMubGVhZGluZzAodGhpcy5vcHRpb25zLmRhdGUuZ2V0TW9udGgoKSArIDEpLFxuICAgICAgICBkYXk6IHRoaXMubGVhZGluZzAodGhpcy5vcHRpb25zLmRhdGUuZ2V0RGF0ZSgpKSxcbiAgICAgIH0gOiB7fSxcbiAgICAgIHRoaXMub3B0aW9ucyxcbiAgICAgIHRoaXMub3B0aW9ucy50YWdzIHx8IHt9KTtcblxuICAgIGlmIChtYXBQYXJhbXMudGltZUZvcm1hdCkge1xuICAgICAgbWFwUGFyYW1zWyd0aW1lJ10gPSBJbnRlcnBvbGF0aW9uU2VydmljZS5pbnRlcnBvbGF0ZShtYXBQYXJhbXMudGltZUZvcm1hdCwgbWFwUGFyYW1zKTtcbiAgICB9XG4gICAgbWFwUGFyYW1zLmxheWVycyA9IG1hcFBhcmFtcy5sYXllcnMgfHwgbWFwUGFyYW1zLmxheWVyIHx8IG1hcFBhcmFtcy52YXJpYWJsZTtcbiAgICBJTlRFUlBPTEFURURfUEFSQU1FVEVSUy5mb3JFYWNoKHA9PntcbiAgICAgIGlmKG1hcFBhcmFtc1twXSl7XG4gICAgICAgIG1hcFBhcmFtc1twXSA9IEludGVycG9sYXRpb25TZXJ2aWNlLmludGVycG9sYXRlKG1hcFBhcmFtc1twXSxtYXBQYXJhbXMpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHRoaXMuaW50ZXJwb2xhdGVkRmlsZSA9IEludGVycG9sYXRpb25TZXJ2aWNlLmludGVycG9sYXRlKHRoaXMuaW50ZXJwb2xhdGVkRmlsZSwgbWFwUGFyYW1zKTtcbiAgICB0aGlzLnVybCA9IGJhc2VVUkwgKyBXTVNfVVJMX0ZPUk1BVFtzb2Z0d2FyZV0gKyB0aGlzLmludGVycG9sYXRlZEZpbGU7XG4gICAgaWYoTUFLRV9ET1dOTE9BRF9VUkxbc29mdHdhcmVdKXtcbiAgICAgIHRoaXMuaW50ZXJwb2xhdGVkRG93bmxvYWRVUkw9TUFLRV9ET1dOTE9BRF9VUkxbc29mdHdhcmVdKGhvc3QuZG93bmxvYWRMaW5rfHxiYXNlVVJMLHRoaXMuaW50ZXJwb2xhdGVkRmlsZSx0aGlzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5pbnRlcnBvbGF0ZWREb3dubG9hZFVSTD1ob3N0LmRvd25sb2FkTGlua3x8bnVsbDtcbiAgICB9XG5cbiAgICBpZih0aGlzLmxheWVyLm9wdGlvbnMubGVnZW5kPT09J3dtcycpe1xuICAgICAgdGhpcy5sZWdlbmRVUkwgPSB0aGlzLnVybCArICc/c2VydmljZT1XTVMmcmVxdWVzdD1HZXRMZWdlbmRHcmFwaGljJmZvcm1hdD1pbWFnZS9wbmcnO1xuICAgICAgdGhpcy5sZWdlbmRVUkwgKz0gYCZsYXllcj0ke0ludGVycG9sYXRpb25TZXJ2aWNlLmludGVycG9sYXRlKG1hcFBhcmFtcy5sYXllcnMsbWFwUGFyYW1zKX1gO1xuICAgICAgdGhpcy5sZWdlbmRVUkwgKz0gJyZ2ZXJzaW9uPTEuMS4xJztcbiAgICAgIHRoaXMub3B0aW9ucy5sZWdlbmQ9dHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sZWdlbmRVUkw9bnVsbDtcbiAgICB9XG5cbiAgICBpZiAobWFwUGFyYW1zLnZlY3RvcnMpIHtcbiAgICAgIHRoaXMud21zUGFyYW1ldGVycyA9IG51bGw7XG4gICAgICB0aGlzLmxheWVyVHlwZSA9ICd2ZWN0b3InO1xuICAgICAgbGV0IHN0eWxlcyA9IG1hcFBhcmFtcy5zdHlsZXMgfHwge307XG4gICAgICB0aGlzLl9zdHlsZUZ1bmMgPSAoZjphbnkpPT57XG4gICAgICAgIHJldHVybiBzdHlsZXM7XG4gICAgICB9XG5cbiAgICAgIGlmKG1hcFBhcmFtcy52ZWN0b3JzPT09J3BvaW50JyAmJiBtYXBQYXJhbXMuc3R5bGVzKXtcbiAgICAgICAgdGhpcy5sYXllclR5cGUgPSAnY2lyY2xlJztcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5sYXllclR5cGUgPSAnd21zJztcbiAgICAgIHRoaXMud21zUGFyYW1ldGVycyA9IHt9O1xuICAgICAgV01TX1BBUkFNRVRFUl9OQU1FU1tzb2Z0d2FyZV0uZm9yRWFjaChwYXJhbSA9PiB7XG4gICAgICAgIGlmIChtYXBQYXJhbXNbcGFyYW1dKSB7XG4gICAgICAgICAgdGhpcy53bXNQYXJhbWV0ZXJzW3BhcmFtXSA9IG1hcFBhcmFtc1twYXJhbV07XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICB0aGlzLmZsYXR0ZW5lZFNldHRpbmdzID0gbWFwUGFyYW1zO1xuXG4gICAgaWYobWFwUGFyYW1zLnRpdGxlRm9ybWF0KXtcbiAgICAgIHRoaXMudGl0bGUgPSBJbnRlcnBvbGF0aW9uU2VydmljZS5pbnRlcnBvbGF0ZShtYXBQYXJhbXMudGl0bGVGb3JtYXQsbWFwUGFyYW1zKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnRpdGxlID0gdGhpcy5sYXllci5uYW1lO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBkZWNhZGVUZXh0KGQ6IERhdGUpOiBzdHJpbmcge1xuICBsZXQgZGVjYWRlID0gZC5nZXRGdWxsWWVhcigpLnRvU3RyaW5nKCkuc2xpY2UoMCwgMyk7XG4gIHJldHVybiBgJHtkZWNhZGV9MC0ke2RlY2FkZX05YDtcbn1cbiJdfQ==