import { InterpolationService } from '../interpolation.service';
const PUBLICATION_PRIORITY_ORDER = [
    'annual',
    'monthly',
    'daily'
];
const ɵ0 = (host, fn) => {
    let components = fn.split('/');
    components.pop();
    return `${host}/catalog/${components.join('/')}/catalog.html`;
}, ɵ1 = (host, fn, ml) => {
    return ml.layer.options.downloadPath || `${host}${fn}`;
};
const MAKE_DOWNLOAD_URL = {
    tds: ɵ0,
    static: ɵ1
};
export const WMS_PARAMETER_NAMES = {
    tds: [
        'layers',
        'styles',
        'colorscalerange',
        'abovemaxcolor',
        'belowmincolor',
        'time',
        'transparent',
        'logscale'
    ],
    geoserver: [
        'transparent',
        'layers'
    ],
    esri: [
        'layers',
        'styles',
        'transparent'
    ]
};
export const WMS_URL_FORMAT = {
    tds: '/wms/',
    geoserver: '/wms/',
    esri: '/'
};
export const INTERPOLATED_PARAMETERS = [
    'styles',
    'layers'
];
export class MappedLayer {
    constructor(data) {
        this.options = {
            date: new Date(2016, 0, 1) // Set to most recent available date
        };
        this.retrievedMetadata = {};
        this.wmsParameters = {};
        this.flattenedSettings = {};
        this.opacity = 1.0;
        Object.assign(this, data || {});
        if (this.layerType === undefined) {
            this.layerType = this.wmsParameters ? 'wms' : undefined;
        }
    }
    description() {
        return this.layer.description ||
            (this.retrievedMetadata &&
                this.retrievedMetadata[this.layer.descriptionField || 'long_name']);
    }
    leading0(n) {
        if (n < 10) {
            return '0' + n;
        }
        return '' + n;
    }
    defaultPublication() {
        const priorityPublication = PUBLICATION_PRIORITY_ORDER.find(pp => this.layer.publications.findIndex(lp => (lp.timestep === pp) || (lp.label === pp)) >= 0);
        if (priorityPublication) {
            return this.layer.publications.findIndex(p => (p.label === priorityPublication) || (p.timestep === priorityPublication));
        }
        return this.layer.publications.findIndex(p => !p.skip);
    }
    update() {
        this.options.publication = (this.options.publication === undefined) ?
            this.defaultPublication() :
            this.options.publication;
        const publication = this.layer.publications[this.options.publication];
        const host = publication.options.host || {};
        const baseURL = host.url;
        const software = host.software || 'tds';
        this.interpolatedFile = (publication.options.filepath || '');
        const mapParams = Object.assign({}, this.layer, publication.options, publication.options.mapOptions || {}, this.options.date ? {
            decade: decadeText(this.options.date),
            year: this.options.date.getFullYear(),
            month: this.leading0(this.options.date.getMonth() + 1),
            day: this.leading0(this.options.date.getDate()),
        } : {}, this.options, this.options.tags || {});
        if (mapParams.timeFormat) {
            mapParams['time'] = InterpolationService.interpolate(mapParams.timeFormat, mapParams);
        }
        mapParams.layers = mapParams.layers || mapParams.layer || mapParams.variable;
        INTERPOLATED_PARAMETERS.forEach(p => {
            if (mapParams[p]) {
                mapParams[p] = InterpolationService.interpolate(mapParams[p], mapParams);
            }
        });
        this.interpolatedFile = InterpolationService.interpolate(this.interpolatedFile, mapParams);
        this.url = baseURL + WMS_URL_FORMAT[software] + this.interpolatedFile;
        if (MAKE_DOWNLOAD_URL[software]) {
            this.interpolatedDownloadURL = MAKE_DOWNLOAD_URL[software](host.downloadLink || baseURL, this.interpolatedFile, this);
        }
        else {
            this.interpolatedDownloadURL = host.downloadLink || null;
        }
        if (this.layer.options.legend === 'wms') {
            this.legendURL = this.url + '?service=WMS&request=GetLegendGraphic&format=image/png';
            this.legendURL += `&layer=${InterpolationService.interpolate(mapParams.layers, mapParams)}`;
            this.legendURL += '&version=1.1.1';
            this.options.legend = true;
        }
        else {
            this.legendURL = null;
        }
        if (mapParams.vectors) {
            this.wmsParameters = null;
            this.layerType = 'vector';
            let styles = mapParams.styles || {};
            this._styleFunc = (f) => {
                return styles;
            };
            if (mapParams.vectors === 'point' && mapParams.styles) {
                this.layerType = 'circle';
            }
        }
        else {
            this.layerType = 'wms';
            this.wmsParameters = {};
            WMS_PARAMETER_NAMES[software].forEach(param => {
                if (mapParams[param]) {
                    this.wmsParameters[param] = mapParams[param];
                }
            });
        }
        this.flattenedSettings = mapParams;
        if (mapParams.titleFormat) {
            this.title = InterpolationService.interpolate(mapParams.titleFormat, mapParams);
        }
        else {
            this.title = this.layer.name;
        }
    }
}
function decadeText(d) {
    let decade = d.getFullYear().toString().slice(0, 3);
    return `${decade}0-${decade}9`;
}
export { ɵ0, ɵ1 };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFwcGVkLWxheWVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2RhdGEvbWFwcGVkLWxheWVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBWWhFLE1BQU0sMEJBQTBCLEdBQUc7SUFDakMsUUFBUTtJQUNSLFNBQVM7SUFDVCxPQUFPO0NBQ1IsQ0FBQztXQUdJLENBQUMsSUFBVyxFQUFDLEVBQVMsRUFBQyxFQUFFO0lBQzNCLElBQUksVUFBVSxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDL0IsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ2pCLE9BQU8sR0FBRyxJQUFJLFlBQVksVUFBVSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDO0FBQ2hFLENBQUMsT0FDTSxDQUFDLElBQVcsRUFBQyxFQUFTLEVBQUMsRUFBYyxFQUFDLEVBQUU7SUFDN0MsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxZQUFZLElBQUksR0FBRyxJQUFJLEdBQUcsRUFBRSxFQUFFLENBQUM7QUFDekQsQ0FBQztBQVJILE1BQU0saUJBQWlCLEdBQTZEO0lBQ2xGLEdBQUcsSUFJRjtJQUNELE1BQU0sSUFFTDtDQUNGLENBQUE7QUFFRCxNQUFNLENBQUMsTUFBTSxtQkFBbUIsR0FBZ0M7SUFDOUQsR0FBRyxFQUFFO1FBQ0gsUUFBUTtRQUNSLFFBQVE7UUFDUixpQkFBaUI7UUFDakIsZUFBZTtRQUNmLGVBQWU7UUFDZixNQUFNO1FBQ04sYUFBYTtRQUNiLFVBQVU7S0FDWDtJQUNELFNBQVMsRUFBRTtRQUNULGFBQWE7UUFDYixRQUFRO0tBQ1Q7SUFDRCxJQUFJLEVBQUU7UUFDSixRQUFRO1FBQ1IsUUFBUTtRQUNSLGFBQWE7S0FDZDtDQUNGLENBQUM7QUFFRixNQUFNLENBQUMsTUFBTSxjQUFjLEdBQXlC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QUN6QixJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNwRCxPQUFPLEdBQUcsTUFBTSxLQUFLLE1BQU0sR0FBRyxDQUFDO0FBQ2pDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMYXllciB9IGZyb20gJy4vY2F0YWxvZyc7XG5pbXBvcnQgeyBJbnRlcnBvbGF0aW9uU2VydmljZSB9IGZyb20gJy4uL2ludGVycG9sYXRpb24uc2VydmljZSc7XG5cbmV4cG9ydCB0eXBlIE1hcHBlZExheWVyVHlwZXMgPSAnd21zJyB8ICd2ZWN0b3InIHwgJ2NpcmNsZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTWFwcGVkTGF5ZXJPcHRpb25zIHtcbiAgbGVnZW5kPzogYm9vbGVhbjtcbiAgcHVibGljYXRpb24/OiBudW1iZXI7XG4gIGRhdGU/OiBEYXRlLFxuXG4gIFtrZXk6IHN0cmluZ106IGFueTtcbn1cblxuY29uc3QgUFVCTElDQVRJT05fUFJJT1JJVFlfT1JERVIgPSBbXG4gICdhbm51YWwnLFxuICAnbW9udGhseScsXG4gICdkYWlseSdcbl07XG5cbmNvbnN0IE1BS0VfRE9XTkxPQURfVVJMOntba2V5OnN0cmluZ106KGE6c3RyaW5nLHM6c3RyaW5nLG1sOk1hcHBlZExheWVyKT0+c3RyaW5nfSA9IHtcbiAgdGRzOihob3N0OnN0cmluZyxmbjpzdHJpbmcpPT57XG4gICAgbGV0IGNvbXBvbmVudHMgPSBmbi5zcGxpdCgnLycpO1xuICAgIGNvbXBvbmVudHMucG9wKCk7XG4gICAgcmV0dXJuIGAke2hvc3R9L2NhdGFsb2cvJHtjb21wb25lbnRzLmpvaW4oJy8nKX0vY2F0YWxvZy5odG1sYDtcbiAgfSxcbiAgc3RhdGljOihob3N0OnN0cmluZyxmbjpzdHJpbmcsbWw6TWFwcGVkTGF5ZXIpPT57XG4gICAgcmV0dXJuIG1sLmxheWVyLm9wdGlvbnMuZG93bmxvYWRQYXRoIHx8IGAke2hvc3R9JHtmbn1gO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBXTVNfUEFSQU1FVEVSX05BTUVTOntba2V5OnN0cmluZ106QXJyYXk8c3RyaW5nPn0gPSB7XG4gIHRkczogW1xuICAgICdsYXllcnMnLFxuICAgICdzdHlsZXMnLFxuICAgICdjb2xvcnNjYWxlcmFuZ2UnLFxuICAgICdhYm92ZW1heGNvbG9yJyxcbiAgICAnYmVsb3dtaW5jb2xvcicsXG4gICAgJ3RpbWUnLFxuICAgICd0cmFuc3BhcmVudCcsXG4gICAgJ2xvZ3NjYWxlJ1xuICBdLFxuICBnZW9zZXJ2ZXI6IFtcbiAgICAndHJhbnNwYXJlbnQnLFxuICAgICdsYXllcnMnXG4gIF0sXG4gIGVzcmk6IFtcbiAgICAnbGF5ZXJzJyxcbiAgICAnc3R5bGVzJyxcbiAgICAndHJhbnNwYXJlbnQnXG4gIF1cbn07XG5cbmV4cG9ydCBjb25zdCBXTVNfVVJMX0ZPUk1BVDp7W2tleTpzdHJpbmddOnN0cmluZ30gPSB7XG4gIHRkczonL3dtcy8nLFxuICBnZW9zZXJ2ZXI6Jy93bXMvJyxcbiAgZXNyaTonLydcbn07XG5cbmV4cG9ydCBjb25zdCBJTlRFUlBPTEFURURfUEFSQU1FVEVSUyA9IFtcbiAgJ3N0eWxlcycsXG4gICdsYXllcnMnXG5dO1xuXG5leHBvcnQgY2xhc3MgTWFwcGVkTGF5ZXIge1xuICBjb25zdHJ1Y3RvcihkYXRhPzphbnkpe1xuICAgIE9iamVjdC5hc3NpZ24odGhpcyxkYXRhfHx7fSk7XG4gICAgaWYodGhpcy5sYXllclR5cGU9PT11bmRlZmluZWQpe1xuICAgICAgdGhpcy5sYXllclR5cGUgPSB0aGlzLndtc1BhcmFtZXRlcnM/J3dtcyc6dW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIHRpdGxlOnN0cmluZztcblxuICBsYXllcjogTGF5ZXI7XG4gIG9wdGlvbnM6IE1hcHBlZExheWVyT3B0aW9ucyA9IHtcbiAgICBkYXRlOiBuZXcgRGF0ZSgyMDE2LCAwLCAxKSAvLyBTZXQgdG8gbW9zdCByZWNlbnQgYXZhaWxhYmxlIGRhdGVcbiAgfTtcblxuICBsZWdlbmRVUkw6c3RyaW5nO1xuICBsYXllclR5cGU6IE1hcHBlZExheWVyVHlwZXM7XG4gIHJldHJpZXZlZE1ldGFkYXRhOiB7W2tleTpzdHJpbmddOmFueX0gPSB7fTtcblxuICBpbnRlcnBvbGF0ZWRGaWxlOnN0cmluZztcbiAgaW50ZXJwb2xhdGVkRG93bmxvYWRVUkw6c3RyaW5nO1xuICB1cmw6IHN0cmluZztcbiAgd21zUGFyYW1ldGVyczogYW55ID0ge307XG4gIGZsYXR0ZW5lZFNldHRpbmdzOiBhbnkgPSB7fTtcbiAgc3RhdGljRGF0YTphbnk7XG4gIG9wYWNpdHkgPSAxLjA7XG5cbiAgX3N0eWxlRnVuYzogKGY6YW55KT0+dm9pZDtcblxuICBkZXNjcmlwdGlvbigpOnN0cmluZ3tcbiAgICByZXR1cm4gdGhpcy5sYXllci5kZXNjcmlwdGlvbiB8fFxuICAgICAgKHRoaXMucmV0cmlldmVkTWV0YWRhdGEgJiZcbiAgICAgICB0aGlzLnJldHJpZXZlZE1ldGFkYXRhW3RoaXMubGF5ZXIuZGVzY3JpcHRpb25GaWVsZHx8J2xvbmdfbmFtZSddKTtcbiAgfVxuXG4gIGxlYWRpbmcwKG46IG51bWJlcik6IHN0cmluZyB7XG4gICAgaWYgKG4gPCAxMCkge1xuICAgICAgcmV0dXJuICcwJyArIG47XG4gICAgfVxuICAgIHJldHVybiAnJyArIG47XG4gIH1cblxuICBkZWZhdWx0UHVibGljYXRpb24oKTpudW1iZXJ7XG4gICAgY29uc3QgcHJpb3JpdHlQdWJsaWNhdGlvbiA9IFBVQkxJQ0FUSU9OX1BSSU9SSVRZX09SREVSLmZpbmQoXG4gICAgICBwcD0+dGhpcy5sYXllci5wdWJsaWNhdGlvbnMuZmluZEluZGV4KGxwPT4obHAudGltZXN0ZXA9PT1wcCl8fChscC5sYWJlbD09PXBwKSk+PTApO1xuICAgIGlmKHByaW9yaXR5UHVibGljYXRpb24pe1xuICAgICAgcmV0dXJuIHRoaXMubGF5ZXIucHVibGljYXRpb25zLmZpbmRJbmRleChwPT4ocC5sYWJlbD09PXByaW9yaXR5UHVibGljYXRpb24pfHwocC50aW1lc3RlcD09PXByaW9yaXR5UHVibGljYXRpb24pKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMubGF5ZXIucHVibGljYXRpb25zLmZpbmRJbmRleChwID0+ICFwLnNraXApO1xuICB9XG5cbiAgdXBkYXRlKCkge1xuICAgIHRoaXMub3B0aW9ucy5wdWJsaWNhdGlvbiA9ICh0aGlzLm9wdGlvbnMucHVibGljYXRpb24gPT09IHVuZGVmaW5lZCkgP1xuICAgICAgdGhpcy5kZWZhdWx0UHVibGljYXRpb24oKSA6XG4gICAgICB0aGlzLm9wdGlvbnMucHVibGljYXRpb247XG5cbiAgICBjb25zdCBwdWJsaWNhdGlvbiA9IHRoaXMubGF5ZXIucHVibGljYXRpb25zW3RoaXMub3B0aW9ucy5wdWJsaWNhdGlvbl07XG5cbiAgICBjb25zdCBob3N0ID0gcHVibGljYXRpb24ub3B0aW9ucy5ob3N0IHx8IHt9O1xuICAgIGNvbnN0IGJhc2VVUkwgPSBob3N0LnVybDtcblxuICAgIGNvbnN0IHNvZnR3YXJlID0gaG9zdC5zb2Z0d2FyZSB8fCAndGRzJztcblxuICAgIHRoaXMuaW50ZXJwb2xhdGVkRmlsZSA9IChwdWJsaWNhdGlvbi5vcHRpb25zLmZpbGVwYXRoIHx8ICcnKVxuICAgIGNvbnN0IG1hcFBhcmFtcyA9IE9iamVjdC5hc3NpZ24oe30sXG4gICAgICB0aGlzLmxheWVyLFxuICAgICAgcHVibGljYXRpb24ub3B0aW9ucyxcbiAgICAgIHB1YmxpY2F0aW9uLm9wdGlvbnMubWFwT3B0aW9ucyB8fCB7fSxcbiAgICAgIHRoaXMub3B0aW9ucy5kYXRlID8ge1xuICAgICAgICBkZWNhZGU6IGRlY2FkZVRleHQodGhpcy5vcHRpb25zLmRhdGUpLFxuICAgICAgICB5ZWFyOiB0aGlzLm9wdGlvbnMuZGF0ZS5nZXRGdWxsWWVhcigpLFxuICAgICAgICBtb250aDogdGhpcy5sZWFkaW5nMCh0aGlzLm9wdGlvbnMuZGF0ZS5nZXRNb250aCgpICsgMSksXG4gICAgICAgIGRheTogdGhpcy5sZWFkaW5nMCh0aGlzLm9wdGlvbnMuZGF0ZS5nZXREYXRlKCkpLFxuICAgICAgfSA6IHt9LFxuICAgICAgdGhpcy5vcHRpb25zLFxuICAgICAgdGhpcy5vcHRpb25zLnRhZ3MgfHwge30pO1xuXG4gICAgaWYgKG1hcFBhcmFtcy50aW1lRm9ybWF0KSB7XG4gICAgICBtYXBQYXJhbXNbJ3RpbWUnXSA9IEludGVycG9sYXRpb25TZXJ2aWNlLmludGVycG9sYXRlKG1hcFBhcmFtcy50aW1lRm9ybWF0LCBtYXBQYXJhbXMpO1xuICAgIH1cbiAgICBtYXBQYXJhbXMubGF5ZXJzID0gbWFwUGFyYW1zLmxheWVycyB8fCBtYXBQYXJhbXMubGF5ZXIgfHwgbWFwUGFyYW1zLnZhcmlhYmxlO1xuICAgIElOVEVSUE9MQVRFRF9QQVJBTUVURVJTLmZvckVhY2gocD0+e1xuICAgICAgaWYobWFwUGFyYW1zW3BdKXtcbiAgICAgICAgbWFwUGFyYW1zW3BdID0gSW50ZXJwb2xhdGlvblNlcnZpY2UuaW50ZXJwb2xhdGUobWFwUGFyYW1zW3BdLG1hcFBhcmFtcyk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5pbnRlcnBvbGF0ZWRGaWxlID0gSW50ZXJwb2xhdGlvblNlcnZpY2UuaW50ZXJwb2xhdGUodGhpcy5pbnRlcnBvbGF0ZWRGaWxlLCBtYXBQYXJhbXMpO1xuICAgIHRoaXMudXJsID0gYmFzZVVSTCArIFdNU19VUkxfRk9STUFUW3NvZnR3YXJlXSArIHRoaXMuaW50ZXJwb2xhdGVkRmlsZTtcbiAgICBpZihNQUtFX0RPV05MT0FEX1VSTFtzb2Z0d2FyZV0pe1xuICAgICAgdGhpcy5pbnRlcnBvbGF0ZWREb3dubG9hZFVSTD1NQUtFX0RPV05MT0FEX1VSTFtzb2Z0d2FyZV0oaG9zdC5kb3dubG9hZExpbmt8fGJhc2VVUkwsdGhpcy5pbnRlcnBvbGF0ZWRGaWxlLHRoaXMpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmludGVycG9sYXRlZERvd25sb2FkVVJMPWhvc3QuZG93bmxvYWRMaW5rfHxudWxsO1xuICAgIH1cblxuICAgIGlmKHRoaXMubGF5ZXIub3B0aW9ucy5sZWdlbmQ9PT0nd21zJyl7XG4gICAgICB0aGlzLmxlZ2VuZFVSTCA9IHRoaXMudXJsICsgJz9zZXJ2aWNlPVdNUyZyZXF1ZXN0PUdldExlZ2VuZEdyYXBoaWMmZm9ybWF0PWltYWdlL3BuZyc7XG4gICAgICB0aGlzLmxlZ2VuZFVSTCArPSBgJmxheWVyPSR7SW50ZXJwb2xhdGlvblNlcnZpY2UuaW50ZXJwb2xhdGUobWFwUGFyYW1zLmxheWVycyxtYXBQYXJhbXMpfWA7XG4gICAgICB0aGlzLmxlZ2VuZFVSTCArPSAnJnZlcnNpb249MS4xLjEnO1xuICAgICAgdGhpcy5vcHRpb25zLmxlZ2VuZD10cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxlZ2VuZFVSTD1udWxsO1xuICAgIH1cblxuICAgIGlmIChtYXBQYXJhbXMudmVjdG9ycykge1xuICAgICAgdGhpcy53bXNQYXJhbWV0ZXJzID0gbnVsbDtcbiAgICAgIHRoaXMubGF5ZXJUeXBlID0gJ3ZlY3Rvcic7XG4gICAgICBsZXQgc3R5bGVzID0gbWFwUGFyYW1zLnN0eWxlcyB8fCB7fTtcbiAgICAgIHRoaXMuX3N0eWxlRnVuYyA9IChmOmFueSk9PntcbiAgICAgICAgcmV0dXJuIHN0eWxlcztcbiAgICAgIH1cblxuICAgICAgaWYobWFwUGFyYW1zLnZlY3RvcnM9PT0ncG9pbnQnICYmIG1hcFBhcmFtcy5zdHlsZXMpe1xuICAgICAgICB0aGlzLmxheWVyVHlwZSA9ICdjaXJjbGUnO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxheWVyVHlwZSA9ICd3bXMnO1xuICAgICAgdGhpcy53bXNQYXJhbWV0ZXJzID0ge307XG4gICAgICBXTVNfUEFSQU1FVEVSX05BTUVTW3NvZnR3YXJlXS5mb3JFYWNoKHBhcmFtID0+IHtcbiAgICAgICAgaWYgKG1hcFBhcmFtc1twYXJhbV0pIHtcbiAgICAgICAgICB0aGlzLndtc1BhcmFtZXRlcnNbcGFyYW1dID0gbWFwUGFyYW1zW3BhcmFtXTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIHRoaXMuZmxhdHRlbmVkU2V0dGluZ3MgPSBtYXBQYXJhbXM7XG5cbiAgICBpZihtYXBQYXJhbXMudGl0bGVGb3JtYXQpe1xuICAgICAgdGhpcy50aXRsZSA9IEludGVycG9sYXRpb25TZXJ2aWNlLmludGVycG9sYXRlKG1hcFBhcmFtcy50aXRsZUZvcm1hdCxtYXBQYXJhbXMpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudGl0bGUgPSB0aGlzLmxheWVyLm5hbWU7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGRlY2FkZVRleHQoZDogRGF0ZSk6IHN0cmluZyB7XG4gIGxldCBkZWNhZGUgPSBkLmdldEZ1bGxZZWFyKCkudG9TdHJpbmcoKS5zbGljZSgwLCAzKTtcbiAgcmV0dXJuIGAke2RlY2FkZX0wLSR7ZGVjYWRlfTlgO1xufVxuIl19