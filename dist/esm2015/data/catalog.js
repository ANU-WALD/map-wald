"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const NAMED_OPTIONS = {
    host: 'namedHosts',
    interval: 'namedIntervals'
};
function clone(v) {
    return JSON.parse(JSON.stringify(v));
}
function matchFirstDefinedKey(keys, lhs, rhs) {
    for (let k of keys) {
        if (lhs[k] && rhs[k]) {
            return lhs[k] === rhs[k];
        }
    }
    return false;
}
function mergeArraysByKeys(keys, ...sources) {
    if (!sources.length) {
        return [];
    }
    var result = clone(sources[0]).map(p => new Publication(p));
    for (var i = 1; i < sources.length; i++) {
        var source = sources[i];
        for (var j = 0; j < source.length; j++) {
            var publication = source[j];
            var match = result.findIndex((pub) => matchFirstDefinedKey(keys, pub, publication));
            if (match >= 0) {
                var options = Object.assign({}, publication.options || {}, result[match].options || {});
                result[match] = Object.assign(new Publication(), publication, result[match]);
                result[match].options = options;
            }
            else {
                result.push(new Publication(clone(publication)));
            }
        }
    }
    result = result.filter(p => !p.skip);
    return result;
}
function propagate(target, source, skipPublications) {
    target.options = Object.assign({}, source.options || {}, target.options || {});
    if (!skipPublications) {
        target.publications = mergeArraysByKeys(['timestep', 'label'], target.publications || [], source.publications || []);
        //    console.log(target.publications);
    }
}
function instantiateNamedOptions(dest, source) {
    for (var key in NAMED_OPTIONS) {
        const configKey = NAMED_OPTIONS[key];
        if (!source[configKey]) {
            continue;
        }
        if (!dest[key] || (typeof (dest[key]) !== 'string')) {
            continue;
        }
        const lookup = dest[key];
        dest[key] = source[configKey][lookup];
    }
}
class CatalogOptions {
}
exports.CatalogOptions = CatalogOptions;
class Catalog {
    constructor(config) {
        this.themes = [];
        if (!config) {
            return;
        }
        Object.assign(this, config);
        this.themes = config.themes.map((t) => new Theme(t));
        this.propagateOptions();
        this.instantiateNamedOptions();
    }
    propagateOptions() {
        this.themes.forEach(t => {
            propagate(t, this);
            t.propagateOptions();
        });
    }
    instantiateNamedOptions() {
        if (this.publications) {
            this.publications.forEach(p => p.instantiateNamedOptions(this));
        }
        this.themes.forEach(t => t.instantiateNamedOptions(this));
    }
    allLayers() {
        return this.themes.map(t => t.layers).reduce((prev, curr) => prev.concat(curr), []);
    }
}
exports.Catalog = Catalog;
class Theme {
    constructor(config) {
        this.layers = [];
        if (!config) {
            return;
        }
        Object.assign(this, config);
        if (config.layers) {
            this.layers = config.layers.map((l) => new Layer(l));
        }
        else {
            this.layers = [];
        }
    }
    propagateOptions() {
        this.layers.forEach(l => {
            propagate(l, this);
            l.propagateOptions();
            l.dataCreator = l.dataCreator || this.dataCreator;
        });
    }
    instantiateNamedOptions(source) {
        instantiateNamedOptions(this.options, source);
        this.publications.forEach(p => p.instantiateNamedOptions(source));
        this.layers.forEach(l => l.instantiateNamedOptions(source));
    }
}
exports.Theme = Theme;
class Layer {
    constructor(config) {
        this.publications = [];
        this.options = new CatalogOptions();
        if (!config) {
            return;
        }
        Object.assign(this, config);
        if (config.publications) {
            this.publications = config.publications.map((p) => new Publication(p));
        }
        else {
            this.publications = [];
        }
    }
    propagateOptions() {
        this.publications.forEach(p => {
            propagate(p, this, true);
        });
    }
    instantiateNamedOptions(source) {
        instantiateNamedOptions(this.options, source);
        this.publications.forEach(p => p.instantiateNamedOptions(source));
    }
}
exports.Layer = Layer;
class Publication {
    constructor(config) {
        this.options = new CatalogOptions();
        if (!config) {
            return;
        }
        Object.assign(this, config);
    }
    instantiateNamedOptions(source) {
        instantiateNamedOptions(this.options, source);
    }
}
exports.Publication = Publication;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2F0YWxvZy5qcyIsInNvdXJjZVJvb3QiOiJuZzovL21hcC13YWxkLyIsInNvdXJjZXMiOlsiZGF0YS9jYXRhbG9nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBSUEsTUFBTSxhQUFhLEdBQXVCO0lBQ3hDLElBQUksRUFBQyxZQUFZO0lBQ2pCLFFBQVEsRUFBQyxnQkFBZ0I7Q0FDMUIsQ0FBQTtBQUVELFNBQVMsS0FBSyxDQUFDLENBQUs7SUFDbEIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN2QyxDQUFDO0FBRUQsU0FBUyxvQkFBb0IsQ0FBQyxJQUFrQixFQUFDLEdBQU8sRUFBQyxHQUFPO0lBQzlELEtBQUksSUFBSSxDQUFDLElBQUksSUFBSSxFQUFDO1FBQ2hCLElBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBQztZQUNoQixPQUFPLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDeEI7S0FDRjtJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQztBQUVELFNBQVMsaUJBQWlCLENBQUMsSUFBa0IsRUFBQyxHQUFHLE9BQWlDO0lBQ2hGLElBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFDO1FBQ2pCLE9BQU8sRUFBRSxDQUFDO0tBQ1g7SUFFRCxJQUFJLE1BQU0sR0FBZ0IsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUEsRUFBRSxDQUFBLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFeEUsS0FBSSxJQUFJLENBQUMsR0FBQyxDQUFDLEVBQUMsQ0FBQyxHQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUMsQ0FBQyxFQUFFLEVBQUM7UUFDL0IsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FB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QW1CQyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHsgQm91bmRzIH0gZnJvbSAnLi9ib3VuZHMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuXG5jb25zdCBOQU1FRF9PUFRJT05TOntba2V5OnN0cmluZ106c3RyaW5nfT17XG4gIGhvc3Q6J25hbWVkSG9zdHMnLFxuICBpbnRlcnZhbDonbmFtZWRJbnRlcnZhbHMnXG59XG5cbmZ1bmN0aW9uIGNsb25lKHY6YW55KTphbnl7XG4gIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHYpKTtcbn1cblxuZnVuY3Rpb24gbWF0Y2hGaXJzdERlZmluZWRLZXkoa2V5czpBcnJheTxzdHJpbmc+LGxoczphbnkscmhzOmFueSk6Ym9vbGVhbntcbiAgZm9yKGxldCBrIG9mIGtleXMpe1xuICAgIGlmKGxoc1trXSYmcmhzW2tdKXtcbiAgICAgIHJldHVybiBsaHNba109PT1yaHNba107XG4gICAgfVxuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cblxuZnVuY3Rpb24gbWVyZ2VBcnJheXNCeUtleXMoa2V5czpBcnJheTxzdHJpbmc+LC4uLnNvdXJjZXM6QXJyYXk8QXJyYXk8UHVibGljYXRpb24+Pik6QXJyYXk8YW55PntcbiAgaWYoIXNvdXJjZXMubGVuZ3RoKXtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICB2YXIgcmVzdWx0ID0gKDxBcnJheTxhbnk+PmNsb25lKHNvdXJjZXNbMF0pKS5tYXAocD0+bmV3IFB1YmxpY2F0aW9uKHApKTtcblxuICBmb3IodmFyIGk9MTtpPHNvdXJjZXMubGVuZ3RoO2krKyl7XG4gICAgdmFyIHNvdXJjZSA9IHNvdXJjZXNbaV07XG4gICAgZm9yKHZhciBqPTA7ajxzb3VyY2UubGVuZ3RoO2orKyl7XG4gICAgICB2YXIgcHVibGljYXRpb246UHVibGljYXRpb24gPSBzb3VyY2Vbal07XG4gICAgICB2YXIgbWF0Y2ggPSByZXN1bHQuZmluZEluZGV4KChwdWI6YW55KT0+bWF0Y2hGaXJzdERlZmluZWRLZXkoa2V5cyxwdWIscHVibGljYXRpb24pKTtcbiAgICAgIGlmKG1hdGNoPj0wKXtcbiAgICAgICAgdmFyIG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LHB1YmxpY2F0aW9uLm9wdGlvbnN8fHt9LHJlc3VsdFttYXRjaF0ub3B0aW9uc3x8e30pXG4gICAgICAgIHJlc3VsdFttYXRjaF0gPSBPYmplY3QuYXNzaWduKG5ldyBQdWJsaWNhdGlvbigpLHB1YmxpY2F0aW9uLHJlc3VsdFttYXRjaF0pO1xuICAgICAgICByZXN1bHRbbWF0Y2hdLm9wdGlvbnMgPSBvcHRpb25zO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzdWx0LnB1c2gobmV3IFB1YmxpY2F0aW9uKGNsb25lKHB1YmxpY2F0aW9uKSkpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXN1bHQgPSByZXN1bHQuZmlsdGVyKHA9PiFwLnNraXApO1xuICByZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiBwcm9wYWdhdGUodGFyZ2V0OmFueSxzb3VyY2U6YW55LHNraXBQdWJsaWNhdGlvbnM/OmJvb2xlYW4pe1xuICB0YXJnZXQub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sc291cmNlLm9wdGlvbnN8fHt9LHRhcmdldC5vcHRpb25zfHx7fSk7XG5cbiAgaWYoIXNraXBQdWJsaWNhdGlvbnMpe1xuICAgIHRhcmdldC5wdWJsaWNhdGlvbnMgPSBtZXJnZUFycmF5c0J5S2V5cyhbJ3RpbWVzdGVwJywnbGFiZWwnXSx0YXJnZXQucHVibGljYXRpb25zfHxbXSxzb3VyY2UucHVibGljYXRpb25zfHxbXSk7XG4vLyAgICBjb25zb2xlLmxvZyh0YXJnZXQucHVibGljYXRpb25zKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpbnN0YW50aWF0ZU5hbWVkT3B0aW9ucyhkZXN0OmFueSxzb3VyY2U6YW55KXtcbiAgZm9yKHZhciBrZXkgaW4gTkFNRURfT1BUSU9OUyl7XG4gICAgY29uc3QgY29uZmlnS2V5OnN0cmluZyA9IE5BTUVEX09QVElPTlNba2V5XTtcbiAgICBpZighc291cmNlW2NvbmZpZ0tleV0pe1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgaWYoIWRlc3Rba2V5XXx8KHR5cGVvZihkZXN0W2tleV0pIT09J3N0cmluZycpKXtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGNvbnN0IGxvb2t1cCA9IGRlc3Rba2V5XTtcbiAgICBkZXN0W2tleV0gPSBzb3VyY2VbY29uZmlnS2V5XVtsb29rdXBdO1xuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2F0YWxvZ0hvc3R7XG4gIHVybD86c3RyaW5nO1xuICBzb2Z0d2FyZT86c3RyaW5nO1xuICBkb3dubG9hZExpbms/OnN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIENhdGFsb2dPcHRpb25ze1xuICBob3N0PzpDYXRhbG9nSG9zdDtcbiAgZG93bmxvYWRQYXRoPzpzdHJpbmc7XG4gIGZpbGVwYXRoPzpzdHJpbmc7XG4gIHBhbGV0dGU/OnN0cmluZztcbiAgY29sb3JzY2FsZXJhbmdlPzpBcnJheTxudW1iZXI+O1xuICBsZWdlbmQ/OnN0cmluZztcbiAgbWFwT3B0aW9ucz86YW55O1xuICB0aW1lRm9ybWF0PzpzdHJpbmc7XG4gIHB1Ymxpc2hlcj86c3RyaW5nO1xuICBwdWJsaXNoZXJVUkw/OnN0cmluZztcbiAgdW5pdHM/OnN0cmluZztcbiAgc21hbGxFeHRlbnQ/OmJvb2xlYW47XG4gIHZlY3RvcnM/OlwicG9pbnRcInxcImxpbmVcInxcInBvbHlnb25cIjtcbiAgc3R5bGVzPzphbnk7XG4gIHB1YmxpY2F0aW9uTGFiZWw/OnN0cmluZztcbiAgdmFyaWFibGU/OnN0cmluZztcbiAgc3RhcnQ/OnN0cmluZztcbiAgZW5kPzpzdHJpbmc7XG59XG5cbmV4cG9ydCBjbGFzcyBDYXRhbG9ne1xuICBuYW1lOnN0cmluZztcbiAgdGhlbWVzOkFycmF5PFRoZW1lPiA9IFtdO1xuICBvcHRpb25zOkNhdGFsb2dPcHRpb25zO1xuICBwdWJsaWNhdGlvbnM6QXJyYXk8UHVibGljYXRpb24+O1xuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZz86YW55KXtcbiAgICBpZighY29uZmlnKXtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLGNvbmZpZyk7XG4gICAgdGhpcy50aGVtZXMgPSBjb25maWcudGhlbWVzLm1hcCgodDphbnkpPT5uZXcgVGhlbWUodCkpO1xuICAgIHRoaXMucHJvcGFnYXRlT3B0aW9ucygpO1xuICAgIHRoaXMuaW5zdGFudGlhdGVOYW1lZE9wdGlvbnMoKTtcbiAgfVxuXG4gIHByb3BhZ2F0ZU9wdGlvbnMoKXtcbiAgICB0aGlzLnRoZW1lcy5mb3JFYWNoKHQ9PntcbiAgICAgIHByb3BhZ2F0ZSh0LHRoaXMpO1xuICAgICAgdC5wcm9wYWdhdGVPcHRpb25zKCk7XG4gICAgfSk7XG4gIH1cblxuICBpbnN0YW50aWF0ZU5hbWVkT3B0aW9ucygpe1xuICAgIGlmKHRoaXMucHVibGljYXRpb25zKXtcbiAgICAgIHRoaXMucHVibGljYXRpb25zLmZvckVhY2gocD0+cC5pbnN0YW50aWF0ZU5hbWVkT3B0aW9ucyh0aGlzKSk7XG4gICAgfVxuICAgIHRoaXMudGhlbWVzLmZvckVhY2godD0+dC5pbnN0YW50aWF0ZU5hbWVkT3B0aW9ucyh0aGlzKSk7XG4gIH1cblxuICBhbGxMYXllcnMoKTpBcnJheTxMYXllcj57XG4gICAgcmV0dXJuIHRoaXMudGhlbWVzLm1hcCh0PT50LmxheWVycykucmVkdWNlKChwcmV2LGN1cnIpPT5wcmV2LmNvbmNhdChjdXJyKSwgW10pO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBUaGVtZXtcbiAgbmFtZTpzdHJpbmc7XG4gIGRhdGFDcmVhdG9yPzpzdHJpbmc7XG4gIHNraXA6Ym9vbGVhbjtcbiAgbGF5ZXJzOkFycmF5PExheWVyPiA9IFtdO1xuICBwYXRoOnN0cmluZztcbiAgb3B0aW9uczpDYXRhbG9nT3B0aW9ucztcbiAgcHVibGljYXRpb25zOkFycmF5PFB1YmxpY2F0aW9uPjtcblxuICBjb25zdHJ1Y3Rvcihjb25maWc/OmFueSl7XG4gICAgaWYoIWNvbmZpZyl7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIE9iamVjdC5hc3NpZ24odGhpcyxjb25maWcpO1xuXG4gICAgaWYoY29uZmlnLmxheWVycyl7XG4gICAgICB0aGlzLmxheWVycyA9IGNvbmZpZy5sYXllcnMubWFwKChsOmFueSk9Pm5ldyBMYXllcihsKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubGF5ZXJzID0gW107XG4gICAgfVxuICB9XG5cbiAgcHJvcGFnYXRlT3B0aW9ucygpe1xuICAgIHRoaXMubGF5ZXJzLmZvckVhY2gobD0+e1xuICAgICAgcHJvcGFnYXRlKGwsdGhpcyk7XG4gICAgICBsLnByb3BhZ2F0ZU9wdGlvbnMoKTtcbiAgICAgIGwuZGF0YUNyZWF0b3IgPSBsLmRhdGFDcmVhdG9yIHx8IHRoaXMuZGF0YUNyZWF0b3I7XG4gICAgfSk7XG4gIH1cblxuICBpbnN0YW50aWF0ZU5hbWVkT3B0aW9ucyhzb3VyY2U6YW55KXtcbiAgICBpbnN0YW50aWF0ZU5hbWVkT3B0aW9ucyh0aGlzLm9wdGlvbnMsc291cmNlKTtcbiAgICB0aGlzLnB1YmxpY2F0aW9ucy5mb3JFYWNoKHA9PnAuaW5zdGFudGlhdGVOYW1lZE9wdGlvbnMoc291cmNlKSk7XG4gICAgdGhpcy5sYXllcnMuZm9yRWFjaChsPT5sLmluc3RhbnRpYXRlTmFtZWRPcHRpb25zKHNvdXJjZSkpO1xuICB9XG5cbn1cblxuZXhwb3J0IGNsYXNzIExheWVye1xuICBwdWJsaWNhdGlvbnM6QXJyYXk8UHVibGljYXRpb24+ID0gW107XG4gIHNraXA6Ym9vbGVhbjtcbiAgb3B0aW9uczpDYXRhbG9nT3B0aW9ucyA9IG5ldyBDYXRhbG9nT3B0aW9ucygpO1xuICBwbGFjZWhvbGRlcjpib29sZWFuO1xuICBuYW1lOnN0cmluZztcbiAgZGF0YUNyZWF0b3I/OnN0cmluZztcbiAgcGF0aDpzdHJpbmc7XG4gIFtrZXk6c3RyaW5nXTphbnk7XG4gIHNwYXRpYWxFeHRlbnQ6IE9ic2VydmFibGU8Qm91bmRzPjtcblxuICBjb25zdHJ1Y3Rvcihjb25maWc/OmFueSl7XG4gICAgaWYoIWNvbmZpZyl7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIE9iamVjdC5hc3NpZ24odGhpcyxjb25maWcpO1xuICAgIGlmKGNvbmZpZy5wdWJsaWNhdGlvbnMpe1xuICAgICAgdGhpcy5wdWJsaWNhdGlvbnMgPSBjb25maWcucHVibGljYXRpb25zLm1hcCgocDphbnkpPT5uZXcgUHVibGljYXRpb24ocCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnB1YmxpY2F0aW9ucyA9IFtdO1xuICAgIH1cbiAgfVxuXG4gIHByb3BhZ2F0ZU9wdGlvbnMoKXtcbiAgICB0aGlzLnB1YmxpY2F0aW9ucy5mb3JFYWNoKHA9PntcbiAgICAgIHByb3BhZ2F0ZShwLHRoaXMsdHJ1ZSk7XG4gICAgfSlcbiAgfVxuXG4gIGluc3RhbnRpYXRlTmFtZWRPcHRpb25zKHNvdXJjZTphbnkpe1xuICAgIGluc3RhbnRpYXRlTmFtZWRPcHRpb25zKHRoaXMub3B0aW9ucyxzb3VyY2UpO1xuICAgIHRoaXMucHVibGljYXRpb25zLmZvckVhY2gocD0+cC5pbnN0YW50aWF0ZU5hbWVkT3B0aW9ucyhzb3VyY2UpKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgUHVibGljYXRpb257XG4gIHRpbWVzdGVwOnN0cmluZztcbiAgdGltZXN0ZXBNdWx0aXBsaWVyOm51bWJlcjtcbiAgdGltZXN0ZXBSZWZlcmVuY2U6c3RyaW5nO1xuICBsYWJlbDpzdHJpbmc7XG4gIHNraXA6Ym9vbGVhbjtcbiAgb3B0aW9uczpDYXRhbG9nT3B0aW9ucyA9IG5ldyBDYXRhbG9nT3B0aW9ucygpO1xuICBwb2ludGRhdGE/OlBvaW50RGF0YTtcblxuICBjb25zdHJ1Y3Rvcihjb25maWc/OmFueSl7XG4gICAgaWYoIWNvbmZpZyl7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIE9iamVjdC5hc3NpZ24odGhpcyxjb25maWcpO1xuICB9XG5cbiAgaW5zdGFudGlhdGVOYW1lZE9wdGlvbnMoc291cmNlOmFueSl7XG4gICAgaW5zdGFudGlhdGVOYW1lZE9wdGlvbnModGhpcy5vcHRpb25zLHNvdXJjZSk7XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBQb2ludERhdGF7XG4gIHByb3RvY29sOnN0cmluZztcbiAgdXJsOnN0cmluZztcbiAgY29vcmRpbmF0ZXM6e1trZXk6c3RyaW5nXTpudW1iZXJ9O1xuICB0YWdzOntba2V5OnN0cmluZ106QXJyYXk8c3RyaW5nfExheWVyVGFnVmFsdWU+fTtcbiAgbGFiZWxzPzpzdHJpbmdbXTtcbiAgZGVmYXVsdFZhcmlhYmxlOnN0cmluZztcbiAgZGlzcGxheUZvcm1hdD86c3RyaW5nO1xuICBjaGFydD86c3RyaW5nO1xuICBleGNsdWRlPzpzdHJpbmdbXTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBMYXllclByb3BlcnR5U3R5bGV7XG4gIGh5cGVybGluaz86Ym9vbGVhbjtcbiAgcGxhY2Vob2xkZXI/OnN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBMYXllclRhZ1ZhbHVle1xuICB2YWx1ZTpzdHJpbmc7XG4gIGxhYmVsOnN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBMYXllclRhZ01hcHtcbiAgW2tleTpzdHJpbmddOkxheWVyVGFnVmFsdWVbXVxufVxuIl19