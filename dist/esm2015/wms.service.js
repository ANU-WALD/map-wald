var WMSService_1;
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
//const proj4 = require('proj4');
//const Proj = proj4.Proj;
//const defs = proj4.defs;
//proj4.InterfaceProjection;
//const InterfaceCoordinates = proj4.InterfaceCoordinates;
//const TemplateCoordinates = proj4.TemplateCoordinates;
//const proj4 = require('proj4').default;
import * as proj4 from 'proj4';
const D2R = Math.PI / 180;
let WMSService = WMSService_1 = class WMSService {
    constructor() {
        this.webMercator = (proj4.default || proj4).Proj('EPSG:3857');
        //this.webMercator = proj4.Proj(proj4.defs('EPSG:3857'));
    }
    pointToWebMercator(pt) {
        var ptRadians = { x: pt.lng() * D2R, y: pt.lat() * D2R };
        var ptWM = this.webMercator.forward({ x: ptRadians.x, y: ptRadians.y });
        return ptWM;
    }
    ;
    computeTileBounds(map, coord, zoom) {
        var proj = map.getProjection();
        var zfactor = Math.pow(2, zoom);
        var xScale = WMSService_1.TILE_WIDTH / zfactor;
        var yScale = WMSService_1.TILE_HEIGHT / zfactor;
        var topLeftLatLng = proj.fromPointToLatLng({ x: coord.x * xScale, y: coord.y * yScale });
        var bottomRightLatLng = proj.fromPointToLatLng({ x: (coord.x + 1) * xScale, y: (coord.y + 1) * yScale });
        var topLeftWebMercator = this.pointToWebMercator(topLeftLatLng);
        var bottomRightWebMercator = this.pointToWebMercator(bottomRightLatLng);
        if (topLeftWebMercator.x > bottomRightWebMercator.x) {
            if (topLeftLatLng.lng() === 180.0) {
                topLeftWebMercator.x = -topLeftWebMercator.x;
            }
            else {
                bottomRightWebMercator.x = -bottomRightWebMercator.x;
            }
        }
        var bbox = [topLeftWebMercator.x, bottomRightWebMercator.y, bottomRightWebMercator.x, topLeftWebMercator.y];
        var bboxTxt = bbox.map((n) => n.toFixed(20).replace(/\.?0+$/, "")); // Avoid e notation on small numbers
        return bboxTxt.join(',');
    }
    ;
    buildImageMap(getMap, getURL, getOptions, getOpacity) {
        var me = this;
        return new window.google.maps.ImageMapType({
            getTileUrl: function (coord, zoom) {
                var theMap = getMap();
                if (!theMap) {
                    return '';
                }
                var bbox = me.computeTileBounds(theMap, coord, zoom);
                var url = getURL(zoom) + '&service=WMS&version=1.1.1&request=GetMap';
                url += "&BBOX=" + bbox; // set bounding box
                url += "&FORMAT=image/png"; //WMS format
                var layerParams = getOptions ? getOptions(zoom) : {};
                layerParams.width = WMSService_1.TILE_WIDTH;
                layerParams.height = WMSService_1.TILE_HEIGHT;
                for (var key in layerParams) {
                    url += '&' + key + '=' + layerParams[key];
                }
                url += "&SRS=EPSG:3857"; //set Web Mercator
                return url;
            },
            tileSize: new window.google.maps.Size(WMSService_1.TILE_SIZE, WMSService_1.TILE_SIZE),
            isPng: true,
            opacity: getOpacity ? getOpacity() : 1.0
        });
    }
    ;
};
WMSService.TILE_SIZE = 256;
WMSService.TILE_WIDTH = WMSService_1.TILE_SIZE;
WMSService.TILE_HEIGHT = WMSService_1.TILE_SIZE;
WMSService = WMSService_1 = tslib_1.__decorate([
    Injectable()
], WMSService);
export { WMSService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid21zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9tYXAtd2FsZC8iLCJzb3VyY2VzIjpbIndtcy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxpQ0FBaUM7QUFDakMsMEJBQTBCO0FBQzFCLDBCQUEwQjtBQUMxQiw0QkFBNEI7QUFDNUIsMERBQTBEO0FBQzFELHdEQUF3RDtBQUV4RCx5Q0FBeUM7QUFDekMsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDL0IsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsR0FBQyxHQUFHLENBQUM7QUFHeEIsSUFBYSxVQUFVLGtCQUF2QixNQUFhLFVBQVU7SUFNckI7UUFDRSxJQUFJLENBQUMsV0FBVyxHQUFHLENBQU8sS0FBTSxDQUFDLE9BQU8sSUFBSSxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDckUseURBQXlEO0lBQzNELENBQUM7SUFJTSxrQkFBa0IsQ0FBQyxFQUFNO1FBQzlCLElBQUksU0FBUyxHQUFHLEVBQUMsQ0FBQyxFQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBQyxHQUFHLEVBQUMsQ0FBQyxFQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBQyxHQUFHLEVBQUMsQ0FBQztRQUNoRCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxFQUFDLENBQUMsRUFBQyxTQUFTLENBQUMsQ0FBQyxFQUFDLENBQUMsRUFBQyxTQUFTLENBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQztRQUNuRSxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFBQSxDQUFDO0lBRUssaUJBQWlCLENBQUMsR0FBTyxFQUFDLEtBQVMsRUFBQyxJQUFXO1FBQ3BELElBQUksSUFBSSxHQUFHLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUMvQixJQUFJ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QUMxQyxXQUFXLENBQUMsTUFBTSxHQUFHLFlBQVUsQ0FBQyxXQUFXLENBQUM7Z0JBQzVDLEtBQUksSUFBSSxHQUFHLElBQUksV0FBVyxFQUFDO29CQUN6QixHQUFHLElBQUksR0FBRyxHQUFDLEdBQUcsR0FBQyxHQUFHLEdBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUNyQztnQkFDRCxHQUFHLElBQUksZ0JBQWdCLENBQUMsQ0FBSyxrQkFBa0I7Z0JBQy9DLE9BQU8sR0FBRyxDQUFDO1lBQ2IsQ0FBQztZQUNELFFBQVEsRUFBQyxJQUFVLE1BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFVLENBQUMsU0FBUyxFQUFDLFlBQVUsQ0FBQyxTQUFTLENBQUM7WUFDdEYsS0FBSyxFQUFDLElBQUk7WUFDVixPQUFPLEVBQUMsVUFBVSxDQUFBLENBQUMsQ0FBQSxVQUFVLEVBQUUsQ0FBQSxDQUFDLENBQUEsR0FBRztTQUNwQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUEsQ0FBQztDQUVILENBQUE7QUEzRVEsb0JBQVMsR0FBQyxHQUFHLENBQUM7QUFDZCxxQkFBVSxHQUFDLFlBQVUsQ0FBQyxTQUFTLENBQUM7QUFDaEMsc0JBQVcsR0FBQyxZQUFVLENBQUMsU0FBUyxDQUFDO0FBSjdCLFVBQVU7SUFEdEIsVUFBVSxFQUFFO0dBQ0EsVUFBVSxDQTZFdEI7U0E3RVksVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbi8vY29uc3QgcHJvajQgPSByZXF1aXJlKCdwcm9qNCcpO1xuLy9jb25zdCBQcm9qID0gcHJvajQuUHJvajtcbi8vY29uc3QgZGVmcyA9IHByb2o0LmRlZnM7XG4vL3Byb2o0LkludGVyZmFjZVByb2plY3Rpb247XG4vL2NvbnN0IEludGVyZmFjZUNvb3JkaW5hdGVzID0gcHJvajQuSW50ZXJmYWNlQ29vcmRpbmF0ZXM7XG4vL2NvbnN0IFRlbXBsYXRlQ29vcmRpbmF0ZXMgPSBwcm9qNC5UZW1wbGF0ZUNvb3JkaW5hdGVzO1xuXG4vL2NvbnN0IHByb2o0ID0gcmVxdWlyZSgncHJvajQnKS5kZWZhdWx0O1xuaW1wb3J0ICogYXMgcHJvajQgZnJvbSAncHJvajQnO1xuY29uc3QgRDJSID0gTWF0aC5QSS8xODA7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBXTVNTZXJ2aWNlIHtcblxuICBzdGF0aWMgVElMRV9TSVpFPTI1NjtcbiAgc3RhdGljIFRJTEVfV0lEVEg9V01TU2VydmljZS5USUxFX1NJWkU7XG4gIHN0YXRpYyBUSUxFX0hFSUdIVD1XTVNTZXJ2aWNlLlRJTEVfU0laRTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLndlYk1lcmNhdG9yID0gKCg8YW55PnByb2o0KS5kZWZhdWx0IHx8IHByb2o0KS5Qcm9qKCdFUFNHOjM4NTcnKTtcbiAgICAvL3RoaXMud2ViTWVyY2F0b3IgPSBwcm9qNC5Qcm9qKHByb2o0LmRlZnMoJ0VQU0c6Mzg1NycpKTtcbiAgfVxuXG4gIHB1YmxpYyB3ZWJNZXJjYXRvcjogYW55O1xuXG4gIHB1YmxpYyBwb2ludFRvV2ViTWVyY2F0b3IocHQ6YW55KTp7eDpudW1iZXIseTpudW1iZXJ9e1xuICAgIHZhciBwdFJhZGlhbnMgPSB7eDpwdC5sbmcoKSpEMlIseTpwdC5sYXQoKSpEMlJ9O1xuICAgIHZhciBwdFdNID0gdGhpcy53ZWJNZXJjYXRvci5mb3J3YXJkKHt4OnB0UmFkaWFucy54LHk6cHRSYWRpYW5zLnl9KTtcbiAgICByZXR1cm4gcHRXTTtcbiAgfTtcblxuICBwdWJsaWMgY29tcHV0ZVRpbGVCb3VuZHMobWFwOmFueSxjb29yZDphbnksem9vbTpudW1iZXIpOnN0cmluZ3tcbiAgICB2YXIgcHJvaiA9IG1hcC5nZXRQcm9qZWN0aW9uKCk7XG4gICAgdmFyIHpmYWN0b3IgPSBNYXRoLnBvdygyLCB6b29tKTtcbiAgICB2YXIgeFNjYWxlID0gV01TU2VydmljZS5USUxFX1dJRFRIL3pmYWN0b3I7XG4gICAgdmFyIHlTY2FsZSA9IFdNU1NlcnZpY2UuVElMRV9IRUlHSFQvemZhY3RvcjtcblxuICAgIHZhciB0b3BMZWZ0TGF0TG5nID0gcHJvai5mcm9tUG9pbnRUb0xhdExuZyh7eDpjb29yZC54ICogeFNjYWxlLCB5OmNvb3JkLnkgKiB5U2NhbGV9KTtcbiAgICB2YXIgYm90dG9tUmlnaHRMYXRMbmcgPSBwcm9qLmZyb21Qb2ludFRvTGF0TG5nKHt4Oihjb29yZC54ICsgMSkgKiB4U2NhbGUsIHk6KGNvb3JkLnkgKyAxKSAqIHlTY2FsZX0pO1xuXG4gICAgdmFyIHRvcExlZnRXZWJNZXJjYXRvciA9IHRoaXMucG9pbnRUb1dlYk1lcmNhdG9yKHRvcExlZnRMYXRMbmcpO1xuICAgIHZhciBib3R0b21SaWdodFdlYk1lcmNhdG9yID0gdGhpcy5wb2ludFRvV2ViTWVyY2F0b3IoYm90dG9tUmlnaHRMYXRMbmcpO1xuXG4gICAgaWYodG9wTGVmdFdlYk1lcmNhdG9yLnggPiBib3R0b21SaWdodFdlYk1lcmNhdG9yLngpe1xuICAgICAgaWYodG9wTGVmdExhdExuZy5sbmcoKT09PTE4MC4wKXtcbiAgICAgICAgdG9wTGVmdFdlYk1lcmNhdG9yLnggPSAtdG9wTGVmdFdlYk1lcmNhdG9yLng7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBib3R0b21SaWdodFdlYk1lcmNhdG9yLnggPSAtYm90dG9tUmlnaHRXZWJNZXJjYXRvci54O1xuICAgICAgfVxuICAgIH1cbiAgICB2YXIgYmJveCA9IFt0b3BMZWZ0V2ViTWVyY2F0b3IueCxib3R0b21SaWdodFdlYk1lcmNhdG9yLnksYm90dG9tUmlnaHRXZWJNZXJjYXRvci54LHRvcExlZnRXZWJNZXJjYXRvci55XTtcbiAgICB2YXIgYmJveFR4dCA9IGJib3gubWFwKChuKT0+bi50b0ZpeGVkKDIwKS5yZXBsYWNlKC9cXC4/MCskLyxcIlwiKSk7IC8vIEF2b2lkIGUgbm90YXRpb24gb24gc21hbGwgbnVtYmVyc1xuICAgIHJldHVybiBiYm94VHh0LmpvaW4oJywnKTtcbiAgfTtcblxuICBwdWJsaWMgYnVpbGRJbWFnZU1hcChnZXRNYXA6KCk9PmFueSxcbiAgICAgICAgICAgICAgICAgICAgICAgZ2V0VVJMOih6b29tOm51bWJlcik9PnN0cmluZyxcbiAgICAgICAgICAgICAgICAgICAgICAgZ2V0T3B0aW9ucz86KHpvb206bnVtYmVyKT0+YW55LFxuICAgICAgICAgICAgICAgICAgICAgICBnZXRPcGFjaXR5PzooKT0+bnVtYmVyKTphbnl7XG4gICAgdmFyIG1lID0gdGhpcztcbiAgICByZXR1cm4gbmV3ICg8YW55PndpbmRvdykuZ29vZ2xlLm1hcHMuSW1hZ2VNYXBUeXBlKHtcbiAgICAgIGdldFRpbGVVcmw6IGZ1bmN0aW9uKGNvb3JkOmFueSx6b29tOm51bWJlcik6c3RyaW5ne1xuICAgICAgICB2YXIgdGhlTWFwID0gZ2V0TWFwKCk7XG4gICAgICAgIGlmKCF0aGVNYXApe1xuICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuXG5cbiAgICAgICAgdmFyIGJib3ggPSBtZS5jb21wdXRlVGlsZUJvdW5kcyh0aGVNYXAsY29vcmQsem9vbSk7XG5cbiAgICAgICAgdmFyIHVybCA9IGdldFVSTCh6b29tKSArICcmc2VydmljZT1XTVMmdmVyc2lvbj0xLjEuMSZyZXF1ZXN0PUdldE1hcCc7XG4gICAgICAgIHVybCArPSBcIiZCQk9YPVwiICsgYmJveDsgICAgICAvLyBzZXQgYm91bmRpbmcgYm94XG4gICAgICAgIHVybCArPSBcIiZGT1JNQVQ9aW1hZ2UvcG5nXCIgOyAvL1dNUyBmb3JtYXRcblxuICAgICAgICB2YXIgbGF5ZXJQYXJhbXMgPSBnZXRPcHRpb25zP2dldE9wdGlvbnMoem9vbSk6e307XG4gICAgICAgIGxheWVyUGFyYW1zLndpZHRoID0gV01TU2VydmljZS5USUxFX1dJRFRIO1xuICAgICAgICBsYXllclBhcmFtcy5oZWlnaHQgPSBXTVNTZXJ2aWNlLlRJTEVfSEVJR0hUO1xuICAgICAgICBmb3IodmFyIGtleSBpbiBsYXllclBhcmFtcyl7XG4gICAgICAgICAgdXJsICs9ICcmJytrZXkrJz0nK2xheWVyUGFyYW1zW2tleV07XG4gICAgICAgIH1cbiAgICAgICAgdXJsICs9IFwiJlNSUz1FUFNHOjM4NTdcIjsgICAgIC8vc2V0IFdlYiBNZXJjYXRvclxuICAgICAgICByZXR1cm4gdXJsO1xuICAgICAgfSxcbiAgICAgIHRpbGVTaXplOm5ldyAoPGFueT53aW5kb3cpLmdvb2dsZS5tYXBzLlNpemUoV01TU2VydmljZS5USUxFX1NJWkUsV01TU2VydmljZS5USUxFX1NJWkUpLFxuICAgICAgaXNQbmc6dHJ1ZSxcbiAgICAgIG9wYWNpdHk6Z2V0T3BhY2l0eT9nZXRPcGFjaXR5KCk6MS4wXG4gICAgfSk7XG4gIH07XG5cbn1cbiJdfQ==