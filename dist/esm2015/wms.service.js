import { Injectable } from '@angular/core';
//const proj4 = require('proj4');
//const Proj = proj4.Proj;
//const defs = proj4.defs;
//proj4.InterfaceProjection;
//const InterfaceCoordinates = proj4.InterfaceCoordinates;
//const TemplateCoordinates = proj4.TemplateCoordinates;
//const proj4 = require('proj4').default;
import * as proj4 from 'proj4';
const D2R = Math.PI / 180;
export class WMSService {
    constructor() {
        this.webMercator = (proj4.default || proj4).Proj('EPSG:3857');
        //this.webMercator = proj4.Proj(proj4.defs('EPSG:3857'));
    }
    pointToWebMercator(pt) {
        var ptRadians = { x: pt.lng() * D2R, y: pt.lat() * D2R };
        var ptWM = this.webMercator.forward({ x: ptRadians.x, y: ptRadians.y });
        return ptWM;
    }
    ;
    computeTileBounds(map, coord, zoom) {
        var proj = map.getProjection();
        var zfactor = Math.pow(2, zoom);
        var xScale = WMSService.TILE_WIDTH / zfactor;
        var yScale = WMSService.TILE_HEIGHT / zfactor;
        var topLeftLatLng = proj.fromPointToLatLng({ x: coord.x * xScale, y: coord.y * yScale });
        var bottomRightLatLng = proj.fromPointToLatLng({ x: (coord.x + 1) * xScale, y: (coord.y + 1) * yScale });
        var topLeftWebMercator = this.pointToWebMercator(topLeftLatLng);
        var bottomRightWebMercator = this.pointToWebMercator(bottomRightLatLng);
        if (topLeftWebMercator.x > bottomRightWebMercator.x) {
            if (topLeftLatLng.lng() === 180.0) {
                topLeftWebMercator.x = -topLeftWebMercator.x;
            }
            else {
                bottomRightWebMercator.x = -bottomRightWebMercator.x;
            }
        }
        var bbox = [topLeftWebMercator.x, bottomRightWebMercator.y, bottomRightWebMercator.x, topLeftWebMercator.y];
        var bboxTxt = bbox.map((n) => n.toFixed(20).replace(/\.?0+$/, "")); // Avoid e notation on small numbers
        return bboxTxt.join(',');
    }
    ;
    buildImageMap(getMap, getURL, getOptions, getOpacity) {
        var me = this;
        return new window.google.maps.ImageMapType({
            getTileUrl: function (coord, zoom) {
                var theMap = getMap();
                if (!theMap) {
                    return '';
                }
                var bbox = me.computeTileBounds(theMap, coord, zoom);
                var url = getURL(zoom) + '&service=WMS&version=1.1.1&request=GetMap';
                url += "&BBOX=" + bbox; // set bounding box
                url += "&FORMAT=image/png"; //WMS format
                var layerParams = getOptions ? getOptions(zoom) : {};
                layerParams.width = WMSService.TILE_WIDTH;
                layerParams.height = WMSService.TILE_HEIGHT;
                for (var key in layerParams) {
                    url += '&' + key + '=' + layerParams[key];
                }
                url += "&SRS=EPSG:3857"; //set Web Mercator
                return url;
            },
            tileSize: new window.google.maps.Size(WMSService.TILE_SIZE, WMSService.TILE_SIZE),
            isPng: true,
            opacity: getOpacity ? getOpacity() : 1.0
        });
    }
    ;
}
WMSService.TILE_SIZE = 256;
WMSService.TILE_WIDTH = WMSService.TILE_SIZE;
WMSService.TILE_HEIGHT = WMSService.TILE_SIZE;
WMSService.decorators = [
    { type: Injectable }
];
WMSService.ctorParameters = () => [];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid21zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvd21zLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxpQ0FBaUM7QUFDakMsMEJBQTBCO0FBQzFCLDBCQUEwQjtBQUMxQiw0QkFBNEI7QUFDNUIsMERBQTBEO0FBQzFELHdEQUF3RDtBQUV4RCx5Q0FBeUM7QUFDekMsT0FBTyxLQUFLLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDL0IsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsR0FBQyxHQUFHLENBQUM7QUFHeEIsTUFBTSxPQUFPLFVBQVU7SUFNckI7UUFDRSxJQUFJLENBQUMsV0FBVyxHQUFHLENBQU8sS0FBTSxDQUFDLE9BQU8sSUFBSSxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDckUseURBQXlEO0lBQzNELENBQUM7SUFJTSxrQkFBa0IsQ0FBQyxFQUFNO1FBQzlCLElBQUksU0FBUyxHQUFHLEVBQUMsQ0FBQyxFQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBQyxHQUFHLEVBQUMsQ0FBQyxFQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsR0FBQyxHQUFHLEVBQUMsQ0FBQztRQUNoRCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxFQUFDLENBQUMsRUFBQyxTQUFTLENBQUMsQ0FBQyxFQUFDLENBQUMsRUFBQyxTQUFTLENBQUMsQ0FBQyxFQUFDLENBQUMsQ0FBQztRQUNuRSxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFBQSxDQUFDO0lBRUssaUJBQWlCLENBQUMsR0FBTyxFQUFDLEtBQVMsRUFBQyxJQUFXO1FBQ3BELElBQUksSUFBSSxHQUFHLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUMvQixJQUFJLE9BQU8sR0FBRyxJQUFJLENB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TSxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUM7Z0JBQzVDLEtBQUksSUFBSSxHQUFHLElBQUksV0FBVyxFQUFDO29CQUN6QixHQUFHLElBQUksR0FBRyxHQUFDLEdBQUcsR0FBQyxHQUFHLEdBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUNyQztnQkFDRCxHQUFHLElBQUksZ0JBQWdCLENBQUMsQ0FBSyxrQkFBa0I7Z0JBQy9DLE9BQU8sR0FBRyxDQUFDO1lBQ2IsQ0FBQztZQUNELFFBQVEsRUFBQyxJQUFVLE1BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxFQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUM7WUFDdEYsS0FBSyxFQUFDLElBQUk7WUFDVixPQUFPLEVBQUMsVUFBVSxDQUFBLENBQUMsQ0FBQSxVQUFVLEVBQUUsQ0FBQSxDQUFDLENBQUEsR0FBRztTQUNwQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUEsQ0FBQzs7QUF6RUssb0JBQVMsR0FBQyxHQUFHLENBQUM7QUFDZCxxQkFBVSxHQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUM7QUFDaEMsc0JBQVcsR0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDOztZQUx6QyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuLy9jb25zdCBwcm9qNCA9IHJlcXVpcmUoJ3Byb2o0Jyk7XG4vL2NvbnN0IFByb2ogPSBwcm9qNC5Qcm9qO1xuLy9jb25zdCBkZWZzID0gcHJvajQuZGVmcztcbi8vcHJvajQuSW50ZXJmYWNlUHJvamVjdGlvbjtcbi8vY29uc3QgSW50ZXJmYWNlQ29vcmRpbmF0ZXMgPSBwcm9qNC5JbnRlcmZhY2VDb29yZGluYXRlcztcbi8vY29uc3QgVGVtcGxhdGVDb29yZGluYXRlcyA9IHByb2o0LlRlbXBsYXRlQ29vcmRpbmF0ZXM7XG5cbi8vY29uc3QgcHJvajQgPSByZXF1aXJlKCdwcm9qNCcpLmRlZmF1bHQ7XG5pbXBvcnQgKiBhcyBwcm9qNCBmcm9tICdwcm9qNCc7XG5jb25zdCBEMlIgPSBNYXRoLlBJLzE4MDtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFdNU1NlcnZpY2Uge1xuXG4gIHN0YXRpYyBUSUxFX1NJWkU9MjU2O1xuICBzdGF0aWMgVElMRV9XSURUSD1XTVNTZXJ2aWNlLlRJTEVfU0laRTtcbiAgc3RhdGljIFRJTEVfSEVJR0hUPVdNU1NlcnZpY2UuVElMRV9TSVpFO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMud2ViTWVyY2F0b3IgPSAoKDxhbnk+cHJvajQpLmRlZmF1bHQgfHwgcHJvajQpLlByb2ooJ0VQU0c6Mzg1NycpO1xuICAgIC8vdGhpcy53ZWJNZXJjYXRvciA9IHByb2o0LlByb2oocHJvajQuZGVmcygnRVBTRzozODU3JykpO1xuICB9XG5cbiAgcHVibGljIHdlYk1lcmNhdG9yOiBhbnk7XG5cbiAgcHVibGljIHBvaW50VG9XZWJNZXJjYXRvcihwdDphbnkpOnt4Om51bWJlcix5Om51bWJlcn17XG4gICAgdmFyIHB0UmFkaWFucyA9IHt4OnB0LmxuZygpKkQyUix5OnB0LmxhdCgpKkQyUn07XG4gICAgdmFyIHB0V00gPSB0aGlzLndlYk1lcmNhdG9yLmZvcndhcmQoe3g6cHRSYWRpYW5zLngseTpwdFJhZGlhbnMueX0pO1xuICAgIHJldHVybiBwdFdNO1xuICB9O1xuXG4gIHB1YmxpYyBjb21wdXRlVGlsZUJvdW5kcyhtYXA6YW55LGNvb3JkOmFueSx6b29tOm51bWJlcik6c3RyaW5ne1xuICAgIHZhciBwcm9qID0gbWFwLmdldFByb2plY3Rpb24oKTtcbiAgICB2YXIgemZhY3RvciA9IE1hdGgucG93KDIsIHpvb20pO1xuICAgIHZhciB4U2NhbGUgPSBXTVNTZXJ2aWNlLlRJTEVfV0lEVEgvemZhY3RvcjtcbiAgICB2YXIgeVNjYWxlID0gV01TU2VydmljZS5USUxFX0hFSUdIVC96ZmFjdG9yO1xuXG4gICAgdmFyIHRvcExlZnRMYXRMbmcgPSBwcm9qLmZyb21Qb2ludFRvTGF0TG5nKHt4OmNvb3JkLnggKiB4U2NhbGUsIHk6Y29vcmQueSAqIHlTY2FsZX0pO1xuICAgIHZhciBib3R0b21SaWdodExhdExuZyA9IHByb2ouZnJvbVBvaW50VG9MYXRMbmcoe3g6KGNvb3JkLnggKyAxKSAqIHhTY2FsZSwgeTooY29vcmQueSArIDEpICogeVNjYWxlfSk7XG5cbiAgICB2YXIgdG9wTGVmdFdlYk1lcmNhdG9yID0gdGhpcy5wb2ludFRvV2ViTWVyY2F0b3IodG9wTGVmdExhdExuZyk7XG4gICAgdmFyIGJvdHRvbVJpZ2h0V2ViTWVyY2F0b3IgPSB0aGlzLnBvaW50VG9XZWJNZXJjYXRvcihib3R0b21SaWdodExhdExuZyk7XG5cbiAgICBpZih0b3BMZWZ0V2ViTWVyY2F0b3IueCA+IGJvdHRvbVJpZ2h0V2ViTWVyY2F0b3IueCl7XG4gICAgICBpZih0b3BMZWZ0TGF0TG5nLmxuZygpPT09MTgwLjApe1xuICAgICAgICB0b3BMZWZ0V2ViTWVyY2F0b3IueCA9IC10b3BMZWZ0V2ViTWVyY2F0b3IueDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGJvdHRvbVJpZ2h0V2ViTWVyY2F0b3IueCA9IC1ib3R0b21SaWdodFdlYk1lcmNhdG9yLng7XG4gICAgICB9XG4gICAgfVxuICAgIHZhciBiYm94ID0gW3RvcExlZnRXZWJNZXJjYXRvci54LGJvdHRvbVJpZ2h0V2ViTWVyY2F0b3IueSxib3R0b21SaWdodFdlYk1lcmNhdG9yLngsdG9wTGVmdFdlYk1lcmNhdG9yLnldO1xuICAgIHZhciBiYm94VHh0ID0gYmJveC5tYXAoKG4pPT5uLnRvRml4ZWQoMjApLnJlcGxhY2UoL1xcLj8wKyQvLFwiXCIpKTsgLy8gQXZvaWQgZSBub3RhdGlvbiBvbiBzbWFsbCBudW1iZXJzXG4gICAgcmV0dXJuIGJib3hUeHQuam9pbignLCcpO1xuICB9O1xuXG4gIHB1YmxpYyBidWlsZEltYWdlTWFwKGdldE1hcDooKT0+YW55LFxuICAgICAgICAgICAgICAgICAgICAgICBnZXRVUkw6KHpvb206bnVtYmVyKT0+c3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgICBnZXRPcHRpb25zPzooem9vbTpudW1iZXIpPT5hbnksXG4gICAgICAgICAgICAgICAgICAgICAgIGdldE9wYWNpdHk/OigpPT5udW1iZXIpOmFueXtcbiAgICB2YXIgbWUgPSB0aGlzO1xuICAgIHJldHVybiBuZXcgKDxhbnk+d2luZG93KS5nb29nbGUubWFwcy5JbWFnZU1hcFR5cGUoe1xuICAgICAgZ2V0VGlsZVVybDogZnVuY3Rpb24oY29vcmQ6YW55LHpvb206bnVtYmVyKTpzdHJpbmd7XG4gICAgICAgIHZhciB0aGVNYXAgPSBnZXRNYXAoKTtcbiAgICAgICAgaWYoIXRoZU1hcCl7XG4gICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICB9XG5cblxuICAgICAgICB2YXIgYmJveCA9IG1lLmNvbXB1dGVUaWxlQm91bmRzKHRoZU1hcCxjb29yZCx6b29tKTtcblxuICAgICAgICB2YXIgdXJsID0gZ2V0VVJMKHpvb20pICsgJyZzZXJ2aWNlPVdNUyZ2ZXJzaW9uPTEuMS4xJnJlcXVlc3Q9R2V0TWFwJztcbiAgICAgICAgdXJsICs9IFwiJkJCT1g9XCIgKyBiYm94OyAgICAgIC8vIHNldCBib3VuZGluZyBib3hcbiAgICAgICAgdXJsICs9IFwiJkZPUk1BVD1pbWFnZS9wbmdcIiA7IC8vV01TIGZvcm1hdFxuXG4gICAgICAgIHZhciBsYXllclBhcmFtcyA9IGdldE9wdGlvbnM/Z2V0T3B0aW9ucyh6b29tKTp7fTtcbiAgICAgICAgbGF5ZXJQYXJhbXMud2lkdGggPSBXTVNTZXJ2aWNlLlRJTEVfV0lEVEg7XG4gICAgICAgIGxheWVyUGFyYW1zLmhlaWdodCA9IFdNU1NlcnZpY2UuVElMRV9IRUlHSFQ7XG4gICAgICAgIGZvcih2YXIga2V5IGluIGxheWVyUGFyYW1zKXtcbiAgICAgICAgICB1cmwgKz0gJyYnK2tleSsnPScrbGF5ZXJQYXJhbXNba2V5XTtcbiAgICAgICAgfVxuICAgICAgICB1cmwgKz0gXCImU1JTPUVQU0c6Mzg1N1wiOyAgICAgLy9zZXQgV2ViIE1lcmNhdG9yXG4gICAgICAgIHJldHVybiB1cmw7XG4gICAgICB9LFxuICAgICAgdGlsZVNpemU6bmV3ICg8YW55PndpbmRvdykuZ29vZ2xlLm1hcHMuU2l6ZShXTVNTZXJ2aWNlLlRJTEVfU0laRSxXTVNTZXJ2aWNlLlRJTEVfU0laRSksXG4gICAgICBpc1BuZzp0cnVlLFxuICAgICAgb3BhY2l0eTpnZXRPcGFjaXR5P2dldE9wYWNpdHkoKToxLjBcbiAgICB9KTtcbiAgfTtcblxufVxuIl19