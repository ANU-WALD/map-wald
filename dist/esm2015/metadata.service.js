import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { OpendapService } from './opendap.service';
import { forkJoin, of } from 'rxjs';
import { publishReplay, refCount, map, switchAll, shareReplay } from 'rxjs/operators';
export const LAT_NAMES = ['latitude', 'lat'];
export const LNG_NAMES = ['longitude', 'lng', 'lon'];
export const TIME_NAMES = ['time', 't', 'Time'];
let MetadataService = class MetadataService {
    constructor(dap) {
        this.dap = dap;
        this.ddxCache = {};
        this.dasCache = {};
        this.timeCache = {};
    }
    identifyCoordinate(ddx, ...possibleNames) {
        for (let n of possibleNames) {
            if (ddx.variables[n]) {
                return n;
            }
        }
        return undefined;
    }
    getDDX(host, file) {
        var url = this.dap.makeURL(host, file);
        return this.ddxForUrl(url);
    }
    ddxForUrl(url) {
        if (!this.ddxCache[url]) {
            this.ddxCache[url] =
                this.dap.getDDX(url).pipe(publishReplay(), refCount());
        }
        return this.ddxCache[url];
    }
    getDDXForLayer(ml) {
        return this.getDDX(ml.flattenedSettings.host, ml.interpolatedFile);
    }
    getDAS(host, file) {
        var url = this.dap.makeURL(host, file);
        return this.dasForUrl(url);
    }
    dasForUrl(url) {
        if (!this.dasCache[url]) {
            this.dasCache[url] =
                this.dap.getDAS(url).pipe(publishReplay(), refCount());
        }
        return this.dasCache[url];
    }
    getDASForLayer(ml) {
        return this.getDAS(ml.flattenedSettings.host, ml.interpolatedFile);
    }
    getMetadata(ml) {
        if (ml.flattenedSettings.host.software !== 'tds') {
            return of({});
        }
        return forkJoin([this.getDASForLayer(ml), this.getDDXForLayer(ml)]).pipe(map(meta => {
            return {
                das: meta[0],
                ddx: meta[1]
            };
        }), map(meta => {
            return Object.assign({}, meta.das.attr || {}, meta.ddx.variables[ml.flattenedSettings.layer || ml.flattenedSettings.variable] || {});
        }));
    }
    populateMetadata(ml) {
        this.getMetadata(ml).subscribe(entry => {
            setTimeout(() => {
                ml.retrievedMetadata = entry;
            });
        });
    }
    getGrid(host, file) {
        const url = this.dap.makeURL(host, file);
        return this.getGridForURL(url);
    }
    getGridForURL(url) {
        const ddx$ = this.ddxForUrl(url);
        const das$ = this.dasForUrl(url);
        const res$ = forkJoin([ddx$, das$]).pipe(map((metadata) => {
            const ddx = metadata[0];
            const das = metadata[1];
            const latCoord = this.identifyCoordinate(ddx, ...LAT_NAMES);
            const lngCoord = this.identifyCoordinate(ddx, ...LNG_NAMES);
            const lat$ = this.dap.getData(`${url}.ascii?${latCoord}`, das).pipe(map((dd) => dd[latCoord]));
            const lng$ = this.dap.getData(`${url}.ascii?${lngCoord}`, das).pipe(map((dd) => dd[lngCoord]));
            return forkJoin(lat$, lng$);
        }), switchAll(), publishReplay(), refCount());
        return res$;
    }
    getGridForLayer(ml) {
        return this.getGrid(ml.flattenedSettings.host, ml.interpolatedFile);
    }
    getSpatialExtent(ml) {
        return this.getGridForLayer(ml).pipe(map(([lats, lngs]) => {
            var result = {
                east: Math.max(...lngs),
                west: Math.min(...lngs),
                north: Math.max(...lats),
                south: Math.min(...lats)
            };
            return result;
        })).pipe(publishReplay(), refCount());
    }
    getTimeDimension(host, file) {
        const url = this.dap.makeURL(host, file);
        return this.getTimeDimensionForURL(url);
    }
    getTimeDimensionForURL(url) {
        if (!this.timeCache[url]) {
            const ddx$ = this.ddxForUrl(url);
            const das$ = this.dasForUrl(url);
            const res$ = forkJoin([ddx$, das$]).pipe(map((metadata) => {
                const ddx = metadata[0];
                const das = metadata[1];
                const timeCoord = this.identifyCoordinate(ddx, ...TIME_NAMES);
                const time$ = this.dap.getData(`${url}.ascii?${timeCoord}`, das).pipe(map((dd) => dd[timeCoord]));
                return time$;
            }), switchAll(), shareReplay());
            this.timeCache[url] = res$;
        }
        return this.timeCache[url];
    }
};
MetadataService.ctorParameters = () => [
    { type: OpendapService }
];
MetadataService = tslib_1.__decorate([
    Injectable()
], MetadataService);
export { MetadataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWV0YWRhdGEuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL21hcC13YWxkLyIsInNvdXJjZXMiOlsibWV0YWRhdGEuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUczQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFJbkQsT0FBTyxFQUFFLFFBQVEsRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDaEQsT0FBTyxFQUFhLGFBQWEsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBTyxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV0RyxNQUFNLENBQUMsTUFBTSxTQUFTLEdBQUMsQ0FBQyxVQUFVLEVBQUMsS0FBSyxDQUFDLENBQUM7QUFDMUMsTUFBTSxDQUFDLE1BQU0sU0FBUyxHQUFDLENBQUMsV0FBVyxFQUFDLEtBQUssRUFBQyxLQUFLLENBQUMsQ0FBQztBQUNqRCxNQUFNLENBQUMsTUFBTSxVQUFVLEdBQUMsQ0FBQyxNQUFNLEVBQUMsR0FBRyxFQUFDLE1BQU0sQ0FBQyxDQUFDO0FBRzVDLElBQWEsZUFBZSxHQUE1QixNQUFhLGVBQWU7SUFJMUIsWUFBb0IsR0FBa0I7UUFBbEIsUUFBRyxHQUFILEdBQUcsQ0FBZTtRQUh0QyxhQUFRLEdBQW1DLEVBQUUsQ0FBQTtRQUM3QyxhQUFRLEdBQW1DLEVBQUUsQ0FBQTtRQWdJN0MsY0FBUyxHQUFtQyxFQUFFLENBQUM7SUE1SC9DLENBQUM7SUFFRCxrQkFBa0IsQ0FBQyxHQUFVLEVBQUMsR0FBRyxhQUEyQjtRQUMxRCxLQUFJLElBQUksQ0FBQyxJQUFJLGFBQWEsRUFBQztZQUN6QixJQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUM7Z0JBQ2xCLE9BQU8sQ0FBQyxDQUFDO2FBQ1Y7U0FDRjtRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENB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QUssQ0FBQztZQUNmLENBQUMsQ0FBQyxFQUFDLFNBQVMsRUFBRSxFQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7WUFDaEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUM7U0FDNUI7UUFDRCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDN0IsQ0FBQztDQUNGLENBQUE7O1lBckp5QixjQUFjOztBQUozQixlQUFlO0lBRDNCLFVBQVUsRUFBRTtHQUNBLGVBQWUsQ0F5SjNCO1NBekpZLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBNYXBwZWRMYXllciB9IGZyb20gJy4vZGF0YS9tYXBwZWQtbGF5ZXInO1xuaW1wb3J0IHsgRGFwRERYLCBEYXBEQVMsIERhcERhdGEgfSBmcm9tICdkYXAtcXVlcnktanMvZGlzdC9kYXAtcXVlcnknO1xuaW1wb3J0IHsgT3BlbmRhcFNlcnZpY2UgfSBmcm9tICcuL29wZW5kYXAuc2VydmljZSc7XG5pbXBvcnQgeyBCb3VuZHMgfSBmcm9tICcuL2RhdGEvYm91bmRzJztcblxuaW1wb3J0IHsgQ2F0YWxvZ0hvc3QgfSBmcm9tICcuL2RhdGEvY2F0YWxvZyc7XG5pbXBvcnQgeyBmb3JrSm9pbiwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHN3aXRjaE1hcCwgcHVibGlzaFJlcGxheSwgcmVmQ291bnQsIG1hcCwgc3dpdGNoQWxsLCB0YXAsIHNoYXJlUmVwbGF5IH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5leHBvcnQgY29uc3QgTEFUX05BTUVTPVsnbGF0aXR1ZGUnLCdsYXQnXTtcbmV4cG9ydCBjb25zdCBMTkdfTkFNRVM9Wydsb25naXR1ZGUnLCdsbmcnLCdsb24nXTtcbmV4cG9ydCBjb25zdCBUSU1FX05BTUVTPVsndGltZScsJ3QnLCdUaW1lJ107XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBNZXRhZGF0YVNlcnZpY2Uge1xuICBkZHhDYWNoZTp7W2tleTpzdHJpbmddOk9ic2VydmFibGU8RGFwRERYPn09e31cbiAgZGFzQ2FjaGU6e1trZXk6c3RyaW5nXTpPYnNlcnZhYmxlPERhcERBUz59PXt9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBkYXA6T3BlbmRhcFNlcnZpY2UpIHtcblxuICB9XG5cbiAgaWRlbnRpZnlDb29yZGluYXRlKGRkeDpEYXBERFgsLi4ucG9zc2libGVOYW1lczpBcnJheTxzdHJpbmc+KTpzdHJpbmd7XG4gICAgZm9yKGxldCBuIG9mIHBvc3NpYmxlTmFtZXMpe1xuICAgICAgaWYoZGR4LnZhcmlhYmxlc1tuXSl7XG4gICAgICAgIHJldHVybiBuO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgZ2V0RERYKGhvc3Q6Q2F0YWxvZ0hvc3QsZmlsZTpzdHJpbmcpOk9ic2VydmFibGU8RGFwRERYPntcbiAgICB2YXIgdXJsID0gdGhpcy5kYXAubWFrZVVSTChob3N0LGZpbGUpO1xuXG4gICAgcmV0dXJuIHRoaXMuZGR4Rm9yVXJsKHVybCk7XG4gIH1cblxuICBkZHhGb3JVcmwodXJsOnN0cmluZyk6T2JzZXJ2YWJsZTxEYXBERFg+e1xuICAgIGlmKCF0aGlzLmRkeENhY2hlW3VybF0pe1xuICAgICAgdGhpcy5kZHhDYWNoZVt1cmxdID1cbiAgICAgICAgdGhpcy5kYXAuZ2V0RERYKHVybCkucGlwZShwdWJsaXNoUmVwbGF5KCkscmVmQ291bnQoKSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuZGR4Q2FjaGVbdXJsXTtcbn1cblxuICBnZXRERFhGb3JMYXllcihtbDpNYXBwZWRMYXllcik6T2JzZXJ2YWJsZTxEYXBERFg+e1xuICAgIHJldHVybiB0aGlzLmdldEREWChtbC5mbGF0dGVuZWRTZXR0aW5ncy5ob3N0LG1sLmludGVycG9sYXRlZEZpbGUpO1xuICB9XG5cbiAgZ2V0REFTKGhvc3Q6Q2F0YWxvZ0hvc3QsZmlsZTpzdHJpbmcpOk9ic2VydmFibGU8RGFwREFTPntcbiAgICB2YXIgdXJsID0gdGhpcy5kYXAubWFrZVVSTChob3N0LGZpbGUpO1xuICAgIHJldHVybiB0aGlzLmRhc0ZvclVybCh1cmwpO1xuICB9XG5cbiAgZGFzRm9yVXJsKHVybDpzdHJpbmcpOk9ic2VydmFibGU8RGFwREFTPntcbiAgICBpZighdGhpcy5kYXNDYWNoZVt1cmxdKXtcbiAgICAgIHRoaXMuZGFzQ2FjaGVbdXJsXSA9XG4gICAgICAgIHRoaXMuZGFwLmdldERBUyh1cmwpLnBpcGUocHVibGlzaFJlcGxheSgpLHJlZkNvdW50KCkpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmRhc0NhY2hlW3VybF07XG4gIH1cblxuICBnZXREQVNGb3JMYXllcihtbDpNYXBwZWRMYXllcik6T2JzZXJ2YWJsZTxEYXBEQVM+e1xuICAgIHJldHVybiB0aGlzLmdldERBUyhtbC5mbGF0dGVuZWRTZXR0aW5ncy5ob3N0LG1sLmludGVycG9sYXRlZEZpbGUpO1xuICB9XG5cbiAgZ2V0TWV0YWRhdGEobWw6TWFwcGVkTGF5ZXIpOk9ic2VydmFibGU8YW55PntcbiAgICBpZihtbC5mbGF0dGVuZWRTZXR0aW5ncy5ob3N0LnNvZnR3YXJlICE9PSd0ZHMnKXtcbiAgICAgIHJldHVybiBvZih7fSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZvcmtKb2luKFt0aGlzLmdldERBU0ZvckxheWVyKG1sKSx0aGlzLmdldEREWEZvckxheWVyKG1sKV0pLnBpcGUoXG4gICAgICBtYXAobWV0YT0+e1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGRhczogPERhcERBUz5tZXRhWzBdLFxuICAgICAgICAgIGRkeDogPERhcEREWD5tZXRhWzFdXG4gICAgICAgIH07XG4gICAgICB9KSxcbiAgICAgIG1hcChtZXRhPT57XG4gICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRhLmRhcy5hdHRyfHx7fSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0YS5kZHgudmFyaWFibGVzW21sLmZsYXR0ZW5lZFNldHRpbmdzLmxheWVyfHxtbC5mbGF0dGVuZWRTZXR0aW5ncy52YXJpYWJsZV18fHt9KTtcbiAgICAgIH0pKTtcbiAgfVxuXG4gIHBvcHVsYXRlTWV0YWRhdGEobWw6TWFwcGVkTGF5ZXIpe1xuICAgIHRoaXMuZ2V0TWV0YWRhdGEobWwpLnN1YnNjcmliZShlbnRyeT0+e1xuICAgICAgc2V0VGltZW91dCgoKT0+e1xuICAgICAgICBtbC5yZXRyaWV2ZWRNZXRhZGF0YSA9IGVudHJ5O1xuICAgICAgfSlcbiAgICB9KTtcbiAgfVxuXG4gIGdldEdyaWQoaG9zdDpDYXRhbG9nSG9zdCxmaWxlOnN0cmluZyk6T2JzZXJ2YWJsZTxudW1iZXJbXVtdPntcbiAgICBjb25zdCB1cmwgPSB0aGlzLmRhcC5tYWtlVVJMKGhvc3QsZmlsZSk7XG4gICAgcmV0dXJuIHRoaXMuZ2V0R3JpZEZvclVSTCh1cmwpO1xuICB9XG5cbiAgZ2V0R3JpZEZvclVSTCh1cmw6c3RyaW5nKTpPYnNlcnZhYmxlPG51bWJlcltdW10+e1xuICAgIGNvbnN0IGRkeCQgPSB0aGlzLmRkeEZvclVybCh1cmwpO1xuICAgIGNvbnN0IGRhcyQgPSB0aGlzLmRhc0ZvclVybCh1cmwpO1xuICAgIGNvbnN0IHJlcyQgPSA8T2JzZXJ2YWJsZTxudW1iZXJbXVtdPj5mb3JrSm9pbihbZGR4JCxkYXMkXSkucGlwZShcbiAgICAgIG1hcCgobWV0YWRhdGE6YW55W10pPT57XG4gICAgICAgIGNvbnN0IGRkeDpEYXBERFggPSBtZXRhZGF0YVswXTtcbiAgICAgICAgY29uc3QgZGFzOkRhcERBUyA9IG1ldGFkYXRhWzFdO1xuXG4gICAgICAgIGNvbnN0IGxhdENvb3JkID0gdGhpcy5pZGVudGlmeUNvb3JkaW5hdGUoZGR4LC4uLkxBVF9OQU1FUyk7XG4gICAgICAgIGNvbnN0IGxuZ0Nvb3JkID0gdGhpcy5pZGVudGlmeUNvb3JkaW5hdGUoZGR4LC4uLkxOR19OQU1FUyk7XG5cbiAgICAgICAgY29uc3QgbGF0JCA9XG4gICAgICAgICAgdGhpcy5kYXAuZ2V0RGF0YShgJHt1cmx9LmFzY2lpPyR7bGF0Q29vcmR9YCxkYXMpLnBpcGUoXG4gICAgICAgICAgICBtYXAoKGRkOkRhcERhdGEpPT48bnVtYmVyW10+ZGRbbGF0Q29vcmRdKSk7XG4gICAgICAgIGNvbnN0IGxuZyQgPVxuICAgICAgICAgIHRoaXMuZGFwLmdldERhdGEoYCR7dXJsfS5hc2NpaT8ke2xuZ0Nvb3JkfWAsZGFzKS5waXBlKFxuICAgICAgICAgICAgbWFwKChkZDpEYXBEYXRhKT0+PG51bWJlcltdPmRkW2xuZ0Nvb3JkXSkpO1xuXG4gICAgICAgIHJldHVybiBmb3JrSm9pbjxudW1iZXJbXT4obGF0JCxsbmckKTtcbiAgICAgIH0pLHN3aXRjaEFsbCgpLHB1Ymxpc2hSZXBsYXkoKSxyZWZDb3VudCgpKTtcbiAgICAgIHJldHVybiByZXMkO1xuICB9XG5cbiAgZ2V0R3JpZEZvckxheWVyKG1sOk1hcHBlZExheWVyKTpPYnNlcnZhYmxlPEFycmF5PEFycmF5PG51bWJlcj4+PntcbiAgICByZXR1cm4gdGhpcy5nZXRHcmlkKG1sLmZsYXR0ZW5lZFNldHRpbmdzLmhvc3QsbWwuaW50ZXJwb2xhdGVkRmlsZSk7XG4gIH1cblxuICBnZXRTcGF0aWFsRXh0ZW50KG1sOk1hcHBlZExheWVyKTpPYnNlcnZhYmxlPEJvdW5kcz57XG4gICAgcmV0dXJuIHRoaXMuZ2V0R3JpZEZvckxheWVyKG1sKS5waXBlKG1hcCgoW2xhdHMsbG5nc10pPT57XG4gICAgICB2YXIgcmVzdWx0OkJvdW5kcyA9IHtcbiAgICAgICAgZWFzdDogTWF0aC5tYXgoLi4ubG5ncyksXG4gICAgICAgIHdlc3Q6IE1hdGgubWluKC4uLmxuZ3MpLFxuICAgICAgICBub3J0aDogTWF0aC5tYXgoLi4ubGF0cyksXG4gICAgICAgIHNvdXRoOiBNYXRoLm1pbiguLi5sYXRzKVxuICAgICAgfTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSkpLnBpcGUocHVibGlzaFJlcGxheSgpLCByZWZDb3VudCgpKTtcbiAgfVxuXG4gIGdldFRpbWVEaW1lbnNpb24oaG9zdDpDYXRhbG9nSG9zdCxmaWxlOnN0cmluZyk6T2JzZXJ2YWJsZTxEYXRlW10+e1xuICAgIGNvbnN0IHVybCA9IHRoaXMuZGFwLm1ha2VVUkwoaG9zdCxmaWxlKTtcbiAgICByZXR1cm4gdGhpcy5nZXRUaW1lRGltZW5zaW9uRm9yVVJMKHVybCk7XG4gIH1cblxuICB0aW1lQ2FjaGU6e1trZXk6c3RyaW5nXTpPYnNlcnZhYmxlPERhdGVbXT59PXt9O1xuXG4gIGdldFRpbWVEaW1lbnNpb25Gb3JVUkwodXJsOnN0cmluZyk6T2JzZXJ2YWJsZTxEYXRlW10+e1xuICAgIGlmKCF0aGlzLnRpbWVDYWNoZVt1cmxdKXtcbiAgICAgIGNvbnN0IGRkeCQgPSB0aGlzLmRkeEZvclVybCh1cmwpO1xuICAgICAgY29uc3QgZGFzJCA9IHRoaXMuZGFzRm9yVXJsKHVybCk7XG4gICAgICBjb25zdCByZXMkID0gPE9ic2VydmFibGU8RGF0ZVtdPj5mb3JrSm9pbihbZGR4JCxkYXMkXSkucGlwZShcbiAgICAgICAgbWFwKChtZXRhZGF0YTphbnlbXSk9PntcbiAgICAgICAgICBjb25zdCBkZHg6RGFwRERYID0gbWV0YWRhdGFbMF07XG4gICAgICAgICAgY29uc3QgZGFzOkRhcERBUyA9IG1ldGFkYXRhWzFdO1xuXG4gICAgICAgICAgY29uc3QgdGltZUNvb3JkID0gdGhpcy5pZGVudGlmeUNvb3JkaW5hdGUoZGR4LC4uLlRJTUVfTkFNRVMpO1xuXG4gICAgICAgICAgY29uc3QgdGltZSQgPVxuICAgICAgICAgICAgdGhpcy5kYXAuZ2V0RGF0YShgJHt1cmx9LmFzY2lpPyR7dGltZUNvb3JkfWAsZGFzKS5waXBlKFxuICAgICAgICAgICAgICBtYXAoKGRkOkRhcERhdGEpPT48RGF0ZVtdPmRkW3RpbWVDb29yZF0pKTtcblxuICAgICAgICAgIHJldHVybiB0aW1lJDtcbiAgICAgICAgfSksc3dpdGNoQWxsKCksc2hhcmVSZXBsYXkoKSk7XG4gICAgICB0aGlzLnRpbWVDYWNoZVt1cmxdID0gcmVzJDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudGltZUNhY2hlW3VybF07XG4gIH1cbn1cbiJdfQ==